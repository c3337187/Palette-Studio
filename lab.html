<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Цветовая лаборатория</title>
  <style>
    :root{
      --bg:#FAF8FB;
      --text:#3C2E40;
      --accent1:#B188C2;
      --accent2:#C9A3E6;
      --warm:#EBC5D8;
      --warm2:#F3DEE6;
      --button:#8C66AF;
      --button-hover:#A57FD0;
      --neutral:#E9E5EC;
      --card-bg:#FFFFFF;
      --surface-primary:var(--bg);
      --surface-card:var(--card-bg);
      --surface-muted:var(--warm2);
      --surface-hero:var(--accent2);
      --surface-accent:var(--accent1);
      --text-strong:var(--text);
      --text-muted:color-mix(in srgb,var(--text) 60%,var(--surface-primary) 40%);
      --border-subtle:var(--neutral);
      --action-primary:var(--button);
      --action-primary-hover:var(--button-hover);
      --badge-accent:var(--warm);
      --font-heading:'Manrope', 'Inter', 'Segoe UI', system-ui, sans-serif;
      --font-body:'Inter', 'Segoe UI', system-ui, sans-serif;
      --font-ui:'Manrope', 'Inter', 'Segoe UI', system-ui, sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--surface-primary),#fff 70%);color:var(--text-strong);font-family:var(--font-body);line-height:1.6;min-height:100vh;overflow-x:hidden}
    a{text-decoration:none;color:inherit}
    .topbar{background:rgba(255,255,255,0.85);backdrop-filter:blur(14px);border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:0;z-index:10}
    .topbar .container{max-width:1200px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;gap:20px}
    .brand{font-weight:700;font-size:18px;letter-spacing:0.06em;text-transform:uppercase;color:#5C4C66}
    .nav-links{display:flex;gap:12px;font-size:14px}
    .nav-link{padding:8px 14px;border-radius:999px;color:var(--text-muted);transition:background .2s,color .2s}
    .nav-link:hover{background:var(--surface-muted);color:var(--text-strong)}
    .nav-link.active{background:var(--action-primary);color:#fff;box-shadow:0 10px 24px rgba(76,45,110,0.2)}
    .layout{max-width:1200px;margin:0 auto;padding:40px 24px 72px;display:grid;grid-template-columns:320px 1fr;gap:28px;align-items:start}
    .sidebar{display:flex;flex-direction:column;gap:20px}
    .panel{background:var(--surface-card);border-radius:18px;padding:20px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 16px 40px rgba(54,38,70,0.12);display:flex;flex-direction:column;gap:16px}
    .panel-head{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .panel h2{margin:0;font-size:18px;font-family:var(--font-heading)}
    .panel p{margin:0;font-size:13px;color:var(--text-muted)}
    .tab-switch{display:flex;gap:8px}
    .tab-button{padding:8px 14px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);font-size:12px;font-weight:600;color:var(--text-muted);cursor:pointer;transition:background .2s,color .2s,box-shadow .2s;font-family:var(--font-ui);text-transform:uppercase;letter-spacing:0.05em}
    .tab-button:hover{background:var(--surface-muted);color:var(--text-strong)}
    .tab-button.active{background:var(--action-primary);color:#fff;border-color:var(--action-primary);box-shadow:0 10px 26px rgba(76,45,110,0.18)}
    .tab-panel{display:none}
    .tab-panel.active{display:block}
    .profile-head{display:flex;flex-direction:column;gap:12px}
    .profile-select{display:flex;flex-direction:column;gap:10px}
    .profile-select select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.12);font-size:14px;background:#fff;color:#43374B}
    .profile-actions{display:flex;flex-wrap:wrap;gap:8px}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);color:var(--text-strong);font-size:13px;font-family:var(--font-ui);cursor:pointer;transition:background .2s,box-shadow .2s}
    .btn:hover{background:var(--surface-muted)}
    .btn.danger{background:#F7E4EA;border-color:#F0B9C8;color:#A63E59}
    .status{font-size:12px;color:var(--text-muted)}
    .token-controls{display:flex;flex-direction:column;gap:0}
    .token-row{display:grid;grid-template-columns:150px 1fr;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.05)}
    .token-row:last-child{border-bottom:none}
    .token-label{display:flex;flex-direction:column;gap:4px}
    .token-label .name{font-size:13px;font-weight:600;color:#43374B}
    .token-label .var{font-family:monospace;font-size:11px;color:#a18cb2}
    .token-inputs{display:flex;gap:8px;align-items:center}
    .token-inputs input[type="color"]{width:40px;height:36px;border:none;background:none;padding:0;cursor:pointer}
    .token-inputs input[type="text"]{width:96px;padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-family:monospace;text-transform:uppercase;font-size:13px;color:#43374B}
    .token-inputs input[type="text"].invalid{border-color:#d16c88;box-shadow:0 0 0 2px rgba(209,108,136,0.25)}
    .alias-controls{display:flex;flex-direction:column}
    .alias-row{display:grid;grid-template-columns:150px 1fr 56px;align-items:start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.05)}
    .alias-row:last-child{border-bottom:none}
    .alias-label{display:flex;flex-direction:column;gap:4px}
    .alias-label .name{font-size:13px;font-weight:600;color:#43374B}
    .alias-label .var{font-family:monospace;font-size:11px;color:#a18cb2}
    .alias-control{display:flex;flex-direction:column;gap:8px}
    .alias-control select{width:100%;padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:13px;background:#fff;color:#43374B}
    .alias-custom{display:flex;gap:8px;align-items:center}
    .alias-custom input[type="color"]{width:36px;height:32px;border:none;padding:0;cursor:pointer;background:none}
    .alias-custom input[type="text"]{width:90px;padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-family:monospace;text-transform:uppercase;font-size:13px}
    .alias-custom input[type="text"].invalid{border-color:#d16c88;box-shadow:0 0 0 2px rgba(209,108,136,0.25)}
    .alias-preview{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)}
    .alias-preview .swatch{width:48px;height:48px;border-radius:12px;border:1px solid rgba(0,0,0,0.05)}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    .generator-form{display:flex;flex-direction:column;gap:14px}
    .generator-row{display:flex;gap:10px;align-items:center}
    .generator-row input[type="text"]{flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:13px;font-family:var(--font-ui)}
    .generator-row input[type="text"].invalid{border-color:#d16c88;box-shadow:0 0 0 2px rgba(209,108,136,0.25)}
    .generator-row input[type="color"]{width:40px;height:36px;border:none;background:none;padding:0;cursor:pointer}
    .generator-actions{display:flex;gap:10px;flex-wrap:wrap}
    .generator-status{font-size:12px;color:var(--text-muted);min-height:16px}
    .preview{display:flex;flex-direction:column;gap:24px}
    .preview header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .preview header h1{margin:0;font-size:26px;font-family:var(--font-heading)}
    .preview header p{margin:6px 0 0;color:var(--text-muted);max-width:520px}
    .profile-chip{padding:6px 12px;border-radius:999px;background:var(--surface-muted);font-size:12px;color:var(--text-strong);font-family:var(--font-ui)}
    .contrast-card{background:var(--surface-card);border:1px solid var(--border-subtle);border-radius:16px;padding:16px;min-width:240px;box-shadow:0 10px 28px rgba(54,38,70,0.08);display:flex;flex-direction:column;gap:10px}
    .contrast-card h2{margin:0;font-size:16px;font-family:var(--font-heading)}
    .contrast-card p{margin:0;font-size:12px;color:var(--text-muted);line-height:1.5}
    .contrast-list{display:flex;flex-direction:column;gap:8px;font-size:13px}
    .contrast-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;border-radius:12px;background:var(--surface-muted);border:1px solid rgba(0,0,0,0.05);transition:border .2s,box-shadow .2s}
    .contrast-item.pass{border-color:rgba(74,149,97,0.4);box-shadow:0 8px 18px rgba(74,149,97,0.08)}
    .contrast-item.warn{border-color:rgba(238,165,61,0.4);box-shadow:0 6px 16px rgba(238,165,61,0.06)}
    .contrast-item.fail{border-color:rgba(212,91,91,0.4);box-shadow:0 6px 14px rgba(212,91,91,0.08)}
    .contrast-item .combo{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .contrast-item .combo .swatch{width:52px;height:32px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;font-weight:700;font-family:var(--font-ui)}
    .contrast-item .ratio{font-family:monospace;font-weight:600}
    .contrast-item .badge{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:600}
    .contrast-item.pass .badge{background:rgba(74,149,97,0.15);color:#2E6B43}
    .contrast-item.warn .badge{background:rgba(238,165,61,0.18);color:#8C4F00}
    .contrast-item.fail .badge{background:rgba(212,91,91,0.18);color:#7C1F1F}
    .contrast-item .guide{font-size:11px;color:var(--text-muted)}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
    .preview-panel{background:var(--surface-card);border-radius:18px;padding:20px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 12px 34px rgba(54,38,70,0.1);display:flex;flex-direction:column;gap:14px}
    .preview-panel header{display:flex;justify-content:space-between;align-items:center}
    .preview-panel header h3{margin:0;font-size:16px;font-family:var(--font-heading)}
    .tag{padding:4px 10px;border-radius:999px;font-size:11px;background:var(--badge-accent);color:var(--text-strong);font-weight:600;text-transform:uppercase;letter-spacing:0.06em}
    .hero-demo{border-radius:14px;padding:24px;background:linear-gradient(135deg,var(--surface-hero),var(--action-primary));color:#fff;display:flex;flex-direction:column;gap:12px;box-shadow:0 16px 42px rgba(0,0,0,0.2)}
    .hero-demo .cta{align-self:flex-start;padding:10px 18px;border-radius:12px;border:none;background:var(--action-primary);color:#fff;font-family:var(--font-ui);font-weight:600;cursor:pointer}
    .hero-demo .cta:hover{background:var(--action-primary-hover)}
    .nav-demo{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:14px;background:var(--surface-muted);border:1px solid var(--border-subtle)}
    .nav-demo .links{display:flex;gap:14px;color:var(--text-muted)}
    .button-stack{display:flex;flex-direction:column;gap:10px}
    .button-stack button{padding:10px 18px;border-radius:12px;border:none;background:var(--action-primary);color:#fff;font-weight:600;font-family:var(--font-ui);box-shadow:0 8px 22px rgba(0,0,0,0.12)}
    .button-stack button[data-state="hover"]{background:var(--action-primary-hover)}
    .button-stack button[data-state="ghost"]{background:var(--surface-card);color:var(--text-strong);border:1px solid var(--border-subtle);box-shadow:none}
    .card-list{display:flex;flex-direction:column;gap:12px}
    .sample-card{padding:16px;border-radius:16px;border:1px solid var(--border-subtle);background:var(--surface-card);display:grid;gap:10px}
    .sample-card h4{margin:0;font-size:15px;font-family:var(--font-heading)}
    .sample-card p{margin:0;color:var(--text-muted);font-size:14px}
    .sample-card .meta{display:flex;justify-content:space-between;align-items:center;color:var(--text-muted);font-size:12px}
    .badge-small{padding:4px 8px;border-radius:999px;background:var(--badge-accent);font-size:11px;font-weight:600;color:var(--text-strong)}
    .form{display:flex;flex-direction:column;gap:12px}
    .form label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
    .form input{padding:10px 12px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);color:var(--text-strong);font-family:var(--font-body)}
    .form input:focus{outline:2px solid color-mix(in srgb,var(--action-primary) 35%,transparent);border-color:var(--action-primary)}
    .form-actions{display:flex;gap:10px;flex-wrap:wrap}
    .ratio-demo{display:flex;flex-direction:column;gap:12px}
    .ratio-bar{display:flex;height:44px;border-radius:16px;overflow:hidden;border:1px solid rgba(0,0,0,0.08);box-shadow:inset 0 -6px 18px rgba(0,0,0,0.05)}
    .ratio-bar span{display:flex;align-items:center;justify-content:center;font-weight:600;font-family:var(--font-ui);font-size:13px}
    .ratio-legend{display:flex;gap:14px;flex-wrap:wrap;font-size:12px;color:var(--text-muted)}
    .ratio-legend span{display:flex;align-items:center;gap:6px}
    .ratio-dot{width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,0.12)}
    .notice{position:fixed;right:24px;bottom:24px;padding:12px 16px;border-radius:12px;background:var(--text-strong);color:#fff;font-size:13px;opacity:0;transform:translateY(12px);transition:all .3s}
    .notice.show{opacity:1;transform:translateY(0)}
    @media(max-width:1100px){
      .layout{grid-template-columns:1fr}
    }
    @media(max-width:720px){
      .layout{padding:32px 16px 56px}
      .token-row,.alias-row{grid-template-columns:1fr}
      .alias-preview{display:none}
      .preview header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="brand">Palette Studio</div>
      <nav class="nav-links">
        <a class="nav-link" href="index.html">Палитра</a>
        <a class="nav-link active" href="lab.html">Лаборатория</a>
        <a class="nav-link" href="fonts.html">Шрифты</a>
      </nav>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <section class="panel">
        <div class="profile-head">
          <h2>Профили палитры</h2>
          <p>Создавайте, копируйте и настраивайте цветовые профили. Изменения сохраняются автоматически.</p>
        </div>
        <div class="profile-select">
          <label style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:#5C4C66">Активный профиль</label>
          <select id="profileSelect"></select>
        </div>
        <div class="profile-actions">
          <button class="btn" id="duplicateProfile">Создать копию</button>
          <button class="btn" id="renameProfile">Переименовать</button>
          <button class="btn danger" id="deleteProfile">Удалить</button>
          <button class="btn danger" id="purgeProfiles">Очистить профили</button>
          <button class="btn" id="resetProfile">Сбросить цвета</button>
        </div>
        <div class="status" id="statusMessage">Готово к редактированию.</div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <div>
            <h2>Генератор 60/30/10</h2>
            <p>Введите основной цвет, и утилита предложит гармоничную палитру, распределённую по правилу 60-30-10.</p>
          </div>
        </div>
        <div class="generator-form" id="generatorForm">
          <div class="generator-row">
            <input type="color" id="generatorColor" value="#6B5B95" aria-label="Основной цвет" />
            <input type="text" id="generatorHex" value="#6B5B95" placeholder="#RRGGBB" aria-label="HEX основного цвета" />
          </div>
          <input type="text" id="generatorName" placeholder="Название нового профиля" aria-label="Название профиля" />
          <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-muted)">
            <input type="checkbox" id="generatorApplyFonts" checked style="width:auto;height:auto" />
            Применить предложенные шрифты из генератора
          </label>
          <div class="generator-actions">
            <button type="button" class="btn" id="generatorCreate">Создать профиль</button>
            <a class="btn" href="#distributionPanel">Показать распределение</a>
          </div>
          <div class="generator-status" id="generatorStatus">Сгенерируйте профиль из основного цвета.</div>
        </div>
      </section>

      <section class="panel" id="colorsPanel">
        <div class="panel-head">
          <div>
            <h2>Цветовые токены</h2>
            <p>Управляйте базовыми значениями и alias-переменными в одном месте.</p>
          </div>
          <div class="tab-switch" role="tablist">
            <button class="tab-button active" type="button" data-tab="base">Базовые</button>
            <button class="tab-button" type="button" data-tab="alias">Alias</button>
          </div>
        </div>
        <div class="tab-panel active" data-panel="base">
          <div class="token-controls" id="baseControls"></div>
        </div>
        <div class="tab-panel" data-panel="alias">
          <div class="alias-controls" id="aliasControls"></div>
        </div>
      </section>

      <section class="panel">
        <div>
          <h2>Экспорт</h2>
          <p>Быстрый обмен с командой: скопируйте CSS или сохраните JSON-файл.</p>
        </div>
        <div class="actions">
          <button class="btn" id="copyCss">Скопировать CSS</button>
          <button class="btn" id="exportJson">Экспорт JSON</button>
          <button class="btn" id="importJson">Импорт JSON</button>
          <button class="btn" id="importText">Вставить конфиг</button>
        </div>
      </section>
    </aside>

    <section class="preview">
      <header>
        <div>
          <h1>Лайв-превью</h1>
          <p>Компоненты справа используют активный профиль и выбранные шрифты. Тестируйте сценарии до внедрения в проект.</p>
          <div class="profile-chip" id="previewProfile">—</div>
        </div>
        <div class="contrast-card">
          <h2>Контраст</h2>
          <p>Ориентируйтесь на WCAG: для обычного текста контраст ≥4.5 (AA) и ≥7.0 (AAA), для крупного текста — ≥3.0 и ≥4.5 соответственно.</p>
          <div class="contrast-list" id="contrastList"></div>
        </div>
      </header>

      <div class="preview-grid">
        <div class="preview-panel" id="distributionPanel">
          <header>
            <h3>Правило 60/30/10</h3>
            <span class="tag">Guideline</span>
          </header>
          <div class="ratio-demo">
            <div class="ratio-bar">
              <span data-ratio="primary">60%</span>
              <span data-ratio="secondary">30%</span>
              <span data-ratio="accent">10%</span>
            </div>
            <div class="ratio-legend">
              <span><span class="ratio-dot" data-ratio-dot="primary"></span>Основной</span>
              <span><span class="ratio-dot" data-ratio-dot="secondary"></span>Вторичный</span>
              <span><span class="ratio-dot" data-ratio-dot="accent"></span>Акцент</span>
            </div>
            <p style="margin:0;font-size:12px;color:var(--text-muted)">Распределяйте площади интерфейса: основной фон занимает ~60%, вторичный поддерживает блоки (~30%), а акцент подчеркивает ключевые точки (~10%).</p>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Hero</h3>
            <span class="tag">Витрина</span>
          </header>
          <div class="hero-demo">
            <span style="font-size:13px;letter-spacing:0.08em;text-transform:uppercase;opacity:0.75">Команда продукта</span>
            <div style="font-size:26px;font-weight:700;font-family:var(--font-heading);line-height:1.2">Создавайте интерфейсы быстрее</div>
            <p style="margin:0;font-size:14px;opacity:0.85">Комбинируйте оттенки, проверяйте контраст и экспортируйте результат.</p>
            <button class="cta">Подробнее</button>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Навигация</h3>
            <span class="tag">Layout</span>
          </header>
          <div class="nav-demo">
            <div style="font-weight:700;font-family:var(--font-heading)">Логотип</div>
            <div class="links">
              <span>Главная</span>
              <span>Продукт</span>
              <span>Контакты</span>
            </div>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Кнопки</h3>
            <span class="tag">CTA</span>
          </header>
          <div class="button-stack">
            <button>Primary</button>
            <button data-state="hover">Hover</button>
            <button data-state="ghost">Ghost</button>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Карточки</h3>
            <span class="tag">Content</span>
          </header>
          <div class="card-list">
            <div class="sample-card">
              <h4>Гайд по цветам</h4>
              <p>Пример карточки, использующей текущие переменные.</p>
              <div class="meta"><span>3 часа назад</span><span class="badge-small">UI Kit</span></div>
            </div>
            <div class="sample-card">
              <h4>Обновление 2.0</h4>
              <p>Синхронизация палитры, alias и шрифтов.</p>
              <div class="meta"><span>Дизайн-команда</span><span class="badge-small">Release</span></div>
            </div>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Форма</h3>
            <span class="tag">Input</span>
          </header>
          <form class="form" onsubmit="return false">
            <label for="preview-name">Имя</label>
            <input id="preview-name" type="text" placeholder="Введите имя" />
            <label for="preview-email">Email</label>
            <input id="preview-email" type="email" placeholder="name@example.com" />
            <div class="form-actions">
              <button class="btn" style="background:var(--action-primary);color:#fff;border:none">Отправить</button>
              <button class="btn" type="button">Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <div class="notice" id="notice"></div>
  <input type="file" id="importInput" accept="application/json" hidden />
  <script src="palette-generator.js"></script>
  <script>
    const STORAGE_KEY = 'palette-studio-profiles';
    const FONT_KEY = 'palette-studio-fonts';

    const BASE_TOKENS = [
      {variable:'--bg', label:'Фон', default:'#FAF8FB'},
      {variable:'--text', label:'Основной текст', default:'#3C2E40'},
      {variable:'--accent1', label:'Акцент мягкий', default:'#B188C2'},
      {variable:'--accent2', label:'Акцент яркий', default:'#C9A3E6'},
      {variable:'--warm', label:'Тёплый акцент', default:'#EBC5D8'},
      {variable:'--warm2', label:'Доп. тёплый', default:'#F3DEE6'},
      {variable:'--button', label:'Кнопка', default:'#8C66AF'},
      {variable:'--button-hover', label:'Кнопка (hover)', default:'#A57FD0'},
      {variable:'--neutral', label:'Нейтральный', default:'#E9E5EC'},
      {variable:'--card-bg', label:'Фон карточек', default:'#FFFFFF'}
    ];

    const ALIAS_DEFS = [
      {variable:'--surface-primary', label:'Поверхность основная', defaultConfig:()=>({mode:'base', ref:'--bg'})},
      {variable:'--surface-card', label:'Поверхность карточек', defaultConfig:()=>({mode:'base', ref:'--card-bg'})},
      {variable:'--surface-muted', label:'Поверхность приглушённая', defaultConfig:()=>({mode:'base', ref:'--warm2'})},
      {variable:'--surface-hero', label:'Hero-поверхность', defaultConfig:()=>({mode:'base', ref:'--accent2'})},
      {variable:'--surface-accent', label:'Акцентная поверхность', defaultConfig:()=>({mode:'base', ref:'--accent1'})},
      {variable:'--text-strong', label:'Текст сильный', defaultConfig:()=>({mode:'base', ref:'--text'})},
      {variable:'--text-muted', label:'Текст вторичный', defaultConfig:()=>({mode:'auto'}), auto:(base, alias)=>computeMutedTextColor(base, alias)},
      {variable:'--border-subtle', label:'Границы мягкие', defaultConfig:()=>({mode:'base', ref:'--neutral'})},
      {variable:'--action-primary', label:'Primary action', defaultConfig:()=>({mode:'base', ref:'--button'})},
      {variable:'--action-primary-hover', label:'Primary hover', defaultConfig:()=>({mode:'base', ref:'--button-hover'})},
      {variable:'--badge-accent', label:'Цвет бейджа', defaultConfig:()=>({mode:'base', ref:'--warm'})}
    ];

    const DEFAULT_PROFILES = [
      {
        id:'soft-light',
        name:'Нейтральный старт',
        base:Object.fromEntries(BASE_TOKENS.map(t=>[t.variable,t.default])),
        aliases:{}
      },
      {
        id:'evening-contrast',
        name:'Вечерний контраст',
        base:{
          '--bg':'#181921',
          '--text':'#FFFFFF',
          '--accent1':'#2E6AFF',
          '--accent2':'#7A5CFF',
          '--warm':'#F2B5A0',
          '--warm2':'#1F2330',
          '--button':'#4250FF',
          '--button-hover':'#5C6CFF',
          '--neutral':'#2C3344',
          '--card-bg':'#1F2533'
        },
        aliases:{
          '--surface-muted':{mode:'base', ref:'--neutral'},
          '--text-muted':{mode:'auto'},
          '--badge-accent':{mode:'base', ref:'--warm'}
        }
      }
    ];

    const DEFAULT_STATE = {activeId:'soft-light', profiles:DEFAULT_PROFILES};

    const LEGACY_FONT_OPTIONS = [
      {id:'manrope', label:'Manrope', stack:"'Manrope', sans-serif", link:'https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'inter', label:'Inter', stack:"'Inter', sans-serif", link:'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'rubik', label:'Rubik', stack:"'Rubik', sans-serif", link:'https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'montserrat', label:'Montserrat', stack:"'Montserrat', sans-serif", link:'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'nunito', label:'Nunito', stack:"'Nunito', sans-serif", link:'https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'raleway', label:'Raleway', stack:"'Raleway', sans-serif", link:'https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'pt-sans', label:'PT Sans', stack:"'PT Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap&subset=cyrillic'},
      {id:'pt-serif', label:'PT Serif', stack:"'PT Serif', serif", link:'https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap&subset=cyrillic'},
      {id:'playfair', label:'Playfair Display', stack:"'Playfair Display', serif", link:'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'lora', label:'Lora', stack:"'Lora', serif", link:'https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'fira-sans', label:'Fira Sans', stack:"'Fira Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'noto-sans', label:'Noto Sans', stack:"'Noto Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'noto-serif', label:'Noto Serif', stack:"'Noto Serif', serif", link:'https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'source-sans', label:'Source Sans 3', stack:"'Source Sans 3', sans-serif", link:'https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'ibm-plex', label:'IBM Plex Sans', stack:"'IBM Plex Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap&subset=cyrillic'},
      {id:'open-sans', label:'Open Sans', stack:"'Open Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'roboto', label:'Roboto', stack:"'Roboto', sans-serif", link:'https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap&subset=cyrillic'},
      {id:'ubuntu', label:'Ubuntu', stack:"'Ubuntu', sans-serif", link:'https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap&subset=cyrillic'},
      {id:'exo2', label:'Exo 2', stack:"'Exo 2', sans-serif", link:'https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'spectral', label:'Spectral', stack:"'Spectral', serif", link:'https://fonts.googleapis.com/css2?family=Spectral:wght@400;500;600;700&display=swap&subset=cyrillic'}
    ];
    const LEGACY_FONT_MAP = Object.fromEntries(LEGACY_FONT_OPTIONS.map(font=>[font.id,{id:font.id,family:font.label,stack:font.stack,css:font.link}]));
    const DEFAULT_FONT_META = {
      heading:{...LEGACY_FONT_MAP.manrope},
      text:{...LEGACY_FONT_MAP.inter},
      ui:{...LEGACY_FONT_MAP.manrope}
    };

    const profileSelect = document.getElementById('profileSelect');
    const baseControls = document.getElementById('baseControls');
    const aliasControls = document.getElementById('aliasControls');
    const statusMessage = document.getElementById('statusMessage');
    const previewProfile = document.getElementById('previewProfile');
    const contrastList = document.getElementById('contrastList');
    const notice = document.getElementById('notice');
    const importInput = document.getElementById('importInput');
    const generatorColor = document.getElementById('generatorColor');
    const generatorHex = document.getElementById('generatorHex');
    const generatorName = document.getElementById('generatorName');
    const generatorApplyFonts = document.getElementById('generatorApplyFonts');
    const generatorCreate = document.getElementById('generatorCreate');
    const generatorStatus = document.getElementById('generatorStatus');
    const ratioSegments = document.querySelectorAll('[data-ratio]');
    const ratioDots = document.querySelectorAll('[data-ratio-dot]');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');

    const duplicateBtn = document.getElementById('duplicateProfile');
    const renameBtn = document.getElementById('renameProfile');
    const deleteBtn = document.getElementById('deleteProfile');
    const purgeBtn = document.getElementById('purgeProfiles');
    const resetBtn = document.getElementById('resetProfile');
    const copyCssBtn = document.getElementById('copyCss');
    const exportBtn = document.getElementById('exportJson');
    const importBtn = document.getElementById('importJson');
    const importTextBtn = document.getElementById('importText');

    let state = loadState();
    let activeProfile = state.profiles.find(p=>p.id===state.activeId) || state.profiles[0];

    let fonts = loadFonts();
    applyFonts(fonts);
    applyPalette(activeProfile);

    initProfileSelect();
    setupTabs();
    setupGenerator();
    buildBaseControls();
    renderAliasControls();
    renderPreview();

    profileSelect.addEventListener('change', e=>{
      setActiveProfile(e.target.value);
      showStatus('Профиль переключён');
    });

    duplicateBtn.addEventListener('click', ()=>{
      const clone = cloneProfile(activeProfile);
      clone.id = randomId();
      clone.name = `${activeProfile.name} (копия)`;
      state.profiles.push(clone);
      setActiveProfile(clone.id);
      saveState();
      initProfileSelect();
      showStatus('Создана копия профиля');
    });

    renameBtn.addEventListener('click', ()=>{
      const name = prompt('Введите новое название профиля', activeProfile.name);
      if(!name) return;
      activeProfile.name = name.trim().substring(0,60) || activeProfile.name;
      saveState();
      initProfileSelect();
      renderPreview();
      showStatus('Название обновлено');
    });

    deleteBtn.addEventListener('click', ()=>{
      if(state.profiles.length<=1){
        alert('Нельзя удалить единственный профиль.');
        return;
      }
      if(!confirm('Удалить текущий профиль?')) return;
      state.profiles = state.profiles.filter(p=>p.id!==activeProfile.id);
      state.activeId = state.profiles[0].id;
      activeProfile = state.profiles[0];
      applyPalette(activeProfile);
      saveState();
      initProfileSelect();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      showStatus('Профиль удалён');
    });

    purgeBtn.addEventListener('click', ()=>{
      if(!confirm('Удалить все профили, кроме активного?')) return;
      const preserved = cloneProfile(activeProfile);
      preserved.id = 'main';
      preserved.name = 'main';
      const normalized = normalizeProfile(preserved);
      state.profiles = [normalized];
      state.activeId = normalized.id;
      activeProfile = state.profiles[0];
      applyPalette(activeProfile);
      saveState();
      initProfileSelect();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      showStatus('Список профилей очищен');
      showNotice('Оставлен только профиль main');
    });

    resetBtn.addEventListener('click', ()=>{
      activeProfile.base = Object.fromEntries(BASE_TOKENS.map(token=>[token.variable, token.default]));
      activeProfile.aliases = {};
      applyPalette(activeProfile);
      saveState();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      showStatus('Цвета сброшены к умолчанию');
    });

    copyCssBtn.addEventListener('click', ()=>{
      const css = buildCssSnippet(activeProfile);
      navigator.clipboard?.writeText(css).then(()=>showNotice('CSS скопирован')).catch(()=>alert('Не удалось скопировать CSS'));
    });

    exportBtn.addEventListener('click', ()=>{
      const bundle = buildExportPayload();
      const data = JSON.stringify(bundle, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'palette-profiles.json';
      a.click();
      URL.revokeObjectURL(url);
      showStatus('Экспортировано в JSON');
    });

    importBtn.addEventListener('click', ()=>importInput.click());

    importTextBtn.addEventListener('click', ()=>{
      const raw = prompt('Вставьте JSON-конфиг профилей и шрифтов', '');
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        handleImportPayload(parsed);
      }catch(err){
        alert('Не удалось обработать конфиг. Проверьте JSON.');
      }
    });

    importInput.addEventListener('change', event=>{
      const file = event.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const parsed = JSON.parse(e.target.result);
          handleImportPayload(parsed);
        }catch(err){
          alert('Не удалось импортировать файл.');
        }
        importInput.value='';
      };
      reader.readAsText(file);
    });

    function handleImportPayload(payload){
      if(!payload || !Array.isArray(payload.profiles)){
        throw new Error('Некорректный формат профиля');
      }
      const hydrated = hydrateState(payload);
      const importedProfiles = hydrated.profiles;
      if(!importedProfiles.length){
        throw new Error('В конфиге отсутствуют профили');
      }

      let added = 0;
      let updated = 0;
      const idMap = new Map();

      importedProfiles.forEach(profile=>{
        const existingIndex = state.profiles.findIndex(p=>p.id===profile.id);
        let finalProfile = cloneProfile(profile);

        if(existingIndex>=0){
          state.profiles[existingIndex] = finalProfile;
          updated++;
        }else{
          if(!finalProfile.id || state.profiles.some(p=>p.id===finalProfile.id)){
            finalProfile = {
              ...finalProfile,
              id: generateUniqueId(finalProfile.id),
              name: formatImportName(finalProfile.name)
            };
          }
          state.profiles.push(finalProfile);
          added++;
        }

        idMap.set(profile.id, finalProfile.id);
      });

      const preferredActive = idMap.get(hydrated.activeId) || hydrated.activeId;
      if(preferredActive && state.profiles.some(p=>p.id===preferredActive)){
        state.activeId = preferredActive;
      }

      activeProfile = state.profiles.find(p=>p.id===state.activeId) || state.profiles[0];
      applyPalette(activeProfile);
      saveState();
      initProfileSelect();
      buildBaseControls();
      renderAliasControls();
      renderPreview();

      const fontsApplied = applyFontPayload(payload.fonts);
      const statusParts = [];
      if(added) statusParts.push(`Добавлено профилей: ${added}`);
      if(updated) statusParts.push(`Обновлено профилей: ${updated}`);
      if(fontsApplied) statusParts.push('Шрифты обновлены');
      if(!statusParts.length) statusParts.push('Импорт выполнен');
      showStatus(statusParts.join('. '));
      showNotice(`Импортировано профилей: ${added+updated}` + (fontsApplied ? ' и шрифты' : ''));
    }

    function initProfileSelect(){
      profileSelect.innerHTML='';
      state.profiles.forEach(profile=>{
        const option = document.createElement('option');
        option.value = profile.id;
        option.textContent = profile.name;
        if(profile.id===activeProfile.id) option.selected = true;
        profileSelect.appendChild(option);
      });
    }

    function buildBaseControls(){
      baseControls.innerHTML='';
      BASE_TOKENS.forEach(token=>{
        const row = document.createElement('div');
        row.className = 'token-row';
        row.dataset.variable = token.variable;

        const label = document.createElement('div');
        label.className = 'token-label';
        label.innerHTML = `<span class="name">${token.label}</span><span class="var">${token.variable}</span>`;

        const inputs = document.createElement('div');
        inputs.className = 'token-inputs';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = activeProfile.base[token.variable];
        colorInput.addEventListener('input', ()=>{
          const value = normalizeHex(colorInput.value);
          if(!value) return;
          activeProfile.base[token.variable] = value;
          hexInput.value = value;
          hexInput.classList.remove('invalid');
          afterBaseUpdate();
        });

        const hexInput = document.createElement('input');
        hexInput.type = 'text';
        hexInput.value = activeProfile.base[token.variable];
        hexInput.maxLength = 7;
        hexInput.addEventListener('input', ()=>{
          const normalized = normalizeHex(hexInput.value);
          if(normalized){
            hexInput.classList.remove('invalid');
            if(normalized !== activeProfile.base[token.variable]){
              activeProfile.base[token.variable] = normalized;
              colorInput.value = normalized;
              afterBaseUpdate();
            }
          }else{
            hexInput.classList.add('invalid');
          }
        });
        hexInput.addEventListener('blur', ()=>{
          const normalized = normalizeHex(hexInput.value) || activeProfile.base[token.variable];
          hexInput.value = normalized;
          hexInput.classList.remove('invalid');
        });

        inputs.append(colorInput, hexInput);

        row.append(label, inputs);
        baseControls.appendChild(row);
      });
    }

    function renderAliasControls(){
      aliasControls.innerHTML='';
      const resolved = resolveAliases(activeProfile);
      ALIAS_DEFS.forEach(def=>{
        const config = activeProfile.aliases[def.variable] || def.defaultConfig();
        const row = document.createElement('div');
        row.className = 'alias-row';
        row.dataset.alias = def.variable;

        const label = document.createElement('div');
        label.className = 'alias-label';
        label.innerHTML = `<span class="name">${def.label}</span><span class="var">${def.variable}</span>`;

        const control = document.createElement('div');
        control.className = 'alias-control';

        const select = document.createElement('select');
        BASE_TOKENS.forEach(token=>{
          const option = document.createElement('option');
          option.value = `base|${token.variable}`;
          option.textContent = `Токен: ${token.label}`;
          if(config.mode==='base' && config.ref===token.variable){
            option.selected = true;
          }
          select.appendChild(option);
        });
        if(def.defaultConfig().mode==='auto' || typeof def.auto==='function'){
          const option = document.createElement('option');
          option.value = 'auto';
          option.textContent = 'Авто (зависит от базовых)';
          if(config.mode==='auto') option.selected = true;
          select.appendChild(option);
        }
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = 'Пользовательский HEX';
        if(config.mode==='custom') customOption.selected = true;
        select.appendChild(customOption);

        const custom = document.createElement('div');
        custom.className = 'alias-custom';
        const customColor = document.createElement('input');
        customColor.type = 'color';
        const customHex = document.createElement('input');
        customHex.type = 'text';
        customHex.maxLength = 7;
        const fallback = config.mode==='custom' && config.value ? config.value : resolved[def.variable];
        customColor.value = fallback;
        customHex.value = fallback;
        if(config.mode!=='custom') custom.style.display='none';

        customHex.addEventListener('input', ()=>{
          const normalized = normalizeHex(customHex.value);
          if(normalized){
            customHex.classList.remove('invalid');
            customColor.value = normalized;
            setAliasConfig(def.variable,{mode:'custom', value:normalized});
          }else{
            customHex.classList.add('invalid');
          }
        });
        customHex.addEventListener('blur', ()=>{
          const normalized = normalizeHex(customHex.value);
          if(normalized){
            customHex.value = normalized;
          }else{
            const current = activeProfile.aliases[def.variable]?.value || resolved[def.variable];
            customHex.value = current;
            customHex.classList.remove('invalid');
          }
        });
        customColor.addEventListener('input', ()=>{
          const value = normalizeHex(customColor.value);
          if(!value) return;
          customHex.value = value;
          customHex.classList.remove('invalid');
          setAliasConfig(def.variable,{mode:'custom', value:value});
        });

        select.addEventListener('change', ()=>{
          const value = select.value;
          if(value.startsWith('base|')){
            const ref = value.split('|')[1];
            setAliasConfig(def.variable,{mode:'base', ref});
            custom.style.display='none';
          }else if(value==='auto'){
            setAliasConfig(def.variable,{mode:'auto'});
            custom.style.display='none';
          }else{
            const current = activeProfile.aliases[def.variable]?.value || resolved[def.variable];
            customHex.value = current;
            customColor.value = current;
            custom.style.display='flex';
            setAliasConfig(def.variable,{mode:'custom', value:current});
          }
        });

        custom.append(customColor, customHex);
        control.append(select, custom);

        const preview = document.createElement('div');
        preview.className = 'alias-preview';
        const swatch = document.createElement('div');
        swatch.className = 'swatch';
        swatch.style.background = resolved[def.variable];
        const value = document.createElement('span');
        value.textContent = resolved[def.variable];
        preview.append(swatch, value);

        row.append(label, control, preview);
        aliasControls.appendChild(row);
      });
    }

    function setupTabs(){
      if(!tabButtons.length) return;
      tabButtons.forEach(button=>{
        button.addEventListener('click', ()=>{
          const target = button.dataset.tab;
          tabButtons.forEach(btn=>btn.classList.toggle('active', btn===button));
          tabPanels.forEach(panel=>panel.classList.toggle('active', panel.dataset.panel===target));
        });
      });
    }

    function setupGenerator(){
      if(!generatorCreate || !generatorHex || !generatorColor) return;
      if(!window.PaletteGenerator || typeof window.PaletteGenerator.generatePalette !== 'function'){
        generatorCreate.disabled = true;
        generatorStatus.textContent = 'Модуль генератора не загрузился.';
        return;
      }
      const {generatePalette} = window.PaletteGenerator;
      const initial = normalizeHex(generatorHex.value || generatorColor.value) || '#6B5B95';
      generatorHex.value = initial;
      generatorColor.value = initial.toLowerCase();

      generatorColor.addEventListener('input', ()=>{
        const normalized = normalizeHex(generatorColor.value);
        generatorHex.value = normalized || generatorColor.value;
        generatorHex.classList.toggle('invalid', !normalized);
      });

      generatorHex.addEventListener('input', ()=>{
        generatorHex.classList.remove('invalid');
      });

      generatorHex.addEventListener('blur', ()=>{
        const normalized = normalizeHex(generatorHex.value);
        if(normalized){
          generatorHex.value = normalized;
          generatorColor.value = normalized.toLowerCase();
          generatorHex.classList.remove('invalid');
        }else{
          generatorHex.classList.add('invalid');
        }
      });

      generatorCreate.addEventListener('click', ()=>{
        const baseHex = normalizeHex(generatorHex.value || generatorColor.value);
        if(!baseHex){
          generatorHex.classList.add('invalid');
          generatorStatus.textContent = 'Введите HEX в формате #RRGGBB.';
          return;
        }
        try{
          generatorHex.classList.remove('invalid');
          const result = generatePalette(baseHex);
          const nameInput = generatorName?.value?.trim();
          const profileName = nameInput || buildGeneratorName(result, baseHex);
          const profile = buildProfileFromGenerated(result, profileName);
          state.profiles.push(profile);
          setActiveProfile(profile.id);
          initProfileSelect();
          generatorName.value = '';
          const messages = [`Профиль «${profile.name}» добавлен.`];
          if(generatorApplyFonts?.checked){
            const applied = applyFontPayload(result.fonts);
            if(applied){
              messages.push(`Шрифты: ${result.profile.fonts.heading} / ${result.profile.fonts.main}`);
            }
          }
          generatorStatus.textContent = messages.join(' ');
          showStatus(`Профиль «${profile.name}» создан генератором.`);
          showNotice('Создан новый профиль из генератора.');
        }catch(error){
          generatorStatus.textContent = error.message || 'Не удалось создать профиль.';
        }
      });
    }

    function setAliasConfig(variable, config){
      activeProfile.aliases[variable] = config;
      applyPalette(activeProfile);
      saveState();
      renderAliasControls();
      renderPreview();
      showStatus('Alias обновлён');
    }

    function afterBaseUpdate(){
      applyPalette(activeProfile);
      saveState();
      renderAliasControls();
      renderPreview();
      showStatus('Цвет сохранён');
    }

    function renderPreview(){
      previewProfile.textContent = activeProfile.name;
      updateRatioPreview();
      updateContrast();
    }

    function updateRatioPreview(){
      if(!ratioSegments.length) return;
      const resolved = resolveAliases(activeProfile);
      const mapping = {
        primary: resolved['--surface-primary'] || activeProfile.base['--bg'],
        secondary: resolved['--surface-muted'] || activeProfile.base['--accent1'],
        accent: resolved['--action-primary'] || activeProfile.base['--button']
      };
      const flexMap = {primary:6, secondary:3, accent:1};
      ratioSegments.forEach(segment=>{
        const key = segment.dataset.ratio;
        const color = mapping[key] || '#CCCCCC';
        const weight = flexMap[key] || 1;
        segment.style.flex = `${weight} ${weight} 0`;
        segment.style.background = color;
        segment.style.color = getReadableTextColor(color);
        const percent = key==='primary' ? 60 : key==='secondary' ? 30 : 10;
        segment.textContent = `${percent}%`;
      });
      ratioDots.forEach(dot=>{
        const key = dot.dataset.ratioDot;
        const color = mapping[key] || '#CCCCCC';
        dot.style.background = color;
        dot.style.borderColor = getReadableTextColor(color);
      });
    }

    function updateContrast(){
      const resolved = resolveAliases(activeProfile);
      const pairs = [
        {label:'Текст / фон', fg:resolved['--text-strong'], bg:resolved['--surface-primary'], kind:'normal', sample:'Aa'},
        {label:'Вторичный текст / фон', fg:resolved['--text-muted'], bg:resolved['--surface-primary'], kind:'normal', sample:'Aa'},
        {label:'Кнопка / текст', fg:'#FFFFFF', bg:resolved['--action-primary'], kind:'large', sample:'BTN'},
        {label:'Кнопка (hover) / текст', fg:'#FFFFFF', bg:resolved['--action-primary-hover'], kind:'large', sample:'BTN'}
      ];
      contrastList.innerHTML='';
      pairs.forEach(pair=>{
        const ratio = calculateContrast(pair.fg, pair.bg);
        const verdict = describeContrast(ratio, pair.kind);
        const item = document.createElement('div');
        item.className = `contrast-item ${verdict.status}`;

        const combo = document.createElement('div');
        combo.className = 'combo';
        const label = document.createElement('span');
        label.textContent = pair.label;
        const swatch = document.createElement('span');
        swatch.className = 'swatch';
        swatch.style.background = pair.bg;
        swatch.style.color = pair.fg;
        swatch.textContent = pair.sample || 'Aa';
        combo.append(label, swatch);

        const meta = document.createElement('div');
        meta.style.display='flex';
        meta.style.alignItems='center';
        meta.style.justifyContent='space-between';
        const ratioSpan = document.createElement('span');
        ratioSpan.className='ratio';
        ratioSpan.textContent = ratio.toFixed(2);
        const badge = document.createElement('span');
        badge.className='badge';
        badge.textContent = verdict.badge;
        meta.append(ratioSpan, badge);

        const guide = document.createElement('span');
        guide.className = 'guide';
        guide.textContent = verdict.helper;

        item.append(combo, meta, guide);
        contrastList.appendChild(item);
      });
    }

    function describeContrast(ratio, kind){
      const thresholds = kind === 'large'
        ? {AA:3, AAA:4.5, label:'крупного текста'}
        : {AA:4.5, AAA:7, label:'обычного текста'};
      if(ratio >= thresholds.AAA){
        return {status:'pass', badge:'AAA', helper:`Отлично: превышает уровень AAA для ${thresholds.label}.`};
      }
      if(ratio >= thresholds.AA){
        return {status:'pass', badge:'AA', helper:`Достаточно: соответствует уровню AA для ${thresholds.label}.`};
      }
      const warnFloor = Math.max(0, thresholds.AA - 0.5);
      if(ratio >= warnFloor){
        return {status:'warn', badge:'Почти', helper:`Почти достаточно — усилите контраст до ${thresholds.AA.toFixed(1)}.`};
      }
      return {status:'fail', badge:'Ниже нормы', helper:`Недостаточно: цель ≥ ${thresholds.AA.toFixed(1)} для ${thresholds.label}.`};
    }

    function setActiveProfile(id){
      const profile = state.profiles.find(p=>p.id===id);
      if(!profile) return;
      activeProfile = profile;
      state.activeId = profile.id;
      applyPalette(activeProfile);
      saveState();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
    }

    function saveState(){
      const payload = {
        activeId: state.activeId,
        profiles: serializeProfiles()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function serializeProfiles(){
      return state.profiles.map(profile=>({
        id: profile.id,
        name: profile.name,
        base: profile.base,
        aliases: profile.aliases
      }));
    }

    function loadState(){
      const fallback = structuredClone(DEFAULT_STATE);
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return hydrateState(fallback);
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.profiles)) return hydrateState(fallback);
        const hydrated = hydrateState(parsed);
        if(!hydrated.profiles.find(p=>p.id===hydrated.activeId)) hydrated.activeId = hydrated.profiles[0]?.id || fallback.activeId;
        return hydrated;
      }catch(e){
        return hydrateState(fallback);
      }
    }

    function hydrateState(state){
      return {
        activeId: state.activeId || state.profiles[0]?.id || 'soft-light',
        profiles: (state.profiles || []).map(normalizeProfile)
      };
    }

    function normalizeProfile(profile){
      const base = {};
      BASE_TOKENS.forEach(token=>{
        const value = profile.base?.[token.variable] || token.default;
        base[token.variable] = normalizeHex(value) || token.default;
      });
      const aliases = {};
      ALIAS_DEFS.forEach(def=>{
        const stored = profile.aliases?.[def.variable];
        let config = stored && stored.mode ? {...stored} : def.defaultConfig();
        if(config.mode==='base' && !BASE_TOKENS.find(t=>t.variable===config.ref)){
          config = def.defaultConfig();
        }
        if(config.mode==='custom'){
          config.value = normalizeHex(config.value || '');
          if(!config.value) config = def.defaultConfig();
        }
        aliases[def.variable] = config;
      });
      return {id: profile.id || randomId(), name: profile.name || 'Безымянный профиль', base, aliases};
    }

    function buildProfileFromGenerated(result, name){
      const base = {...result.tokens};
      const aliases = {...result.aliases};
      const profile = {
        id: generateUniqueId(slugify(name || 'palette')), 
        name: name || 'Новая палитра',
        base,
        aliases
      };
      return normalizeProfile(profile);
    }

    function buildGeneratorName(result, hex){
      const suffix = hex ? hex.replace('#','').toUpperCase() : randomId().slice(-4);
      const prefix = result?.meta?.strategy === '60-30-10' ? 'Палитра 60·30·10' : 'Палитра';
      return `${prefix} ${suffix}`;
    }

    function resolveAliases(profile){
      const aliasColors = {};
      ALIAS_DEFS.forEach(def=>{
        const config = profile.aliases?.[def.variable] || def.defaultConfig();
        let color;
        if(config.mode==='base'){
          color = profile.base[config.ref];
        }else if(config.mode==='custom'){
          color = config.value;
        }else if(config.mode==='auto' && typeof def.auto==='function'){
          color = def.auto(profile.base, aliasColors, config);
        }
        if(!color){
          const fallbackRef = def.defaultConfig().ref;
          color = fallbackRef ? profile.base[fallbackRef] : '#000000';
        }
        aliasColors[def.variable] = color;
      });
      return aliasColors;
    }

    function applyPalette(profile){
      const root = document.documentElement;
      Object.entries(profile.base).forEach(([key,value])=>root.style.setProperty(key,value));
      const aliases = resolveAliases(profile);
      Object.entries(aliases).forEach(([key,value])=>root.style.setProperty(key,value));
    }

    function buildCssSnippet(profile){
      const aliases = resolveAliases(profile);
      const lines = [
        ...Object.entries(profile.base),
        ...Object.entries(aliases)
      ].map(([key,value])=>`  ${key}: ${value};`);
      return `:root\n{\n${lines.join('\n')}\n}`;
    }

    function buildExportPayload(){
      const payload = {
        activeId: state.activeId,
        profiles: serializeProfiles()
      };
      const fontsPayload = getFontExportPayload();
      if(fontsPayload) payload.fonts = fontsPayload;
      return payload;
    }

    function getFontExportPayload(){
      const stored = readStoredFontPayload();
      if(stored) return stored;
      return sanitizeFontPayload(fonts);
    }

    function readStoredFontPayload(){
      try{
        const raw = localStorage.getItem(FONT_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === 'object'){
          return sanitizeFontPayload(parsed);
        }
      }catch(e){
        return null;
      }
      return null;
    }

    function applyFontPayload(payload){
      if(!payload || typeof payload !== 'object') return false;
      try{
        const sanitized = sanitizeFontPayload(payload);
        localStorage.setItem(FONT_KEY, JSON.stringify(sanitized));
        fonts = loadFonts();
        applyFonts(fonts);
        return true;
      }catch(e){
        return false;
      }
    }

    function sanitizeFontPayload(source){
      const roles = ['heading','text','ui'];
      const sanitized = {};
      roles.forEach(role=>{
        const fallback = DEFAULT_FONT_META[role] || {};
        const entry = source && typeof source === 'object' ? source[role] : null;
        const meta = {...fallback};
        if(entry && typeof entry === 'object'){
          if(entry.id) meta.id = entry.id;
          if(entry.family) meta.family = entry.family;
          if(entry.stack) meta.stack = entry.stack;
          if(entry.css) meta.css = entry.css;
          if(entry.category) meta.category = entry.category;
          if(Array.isArray(entry.weights)) meta.weights = entry.weights;
          if(Array.isArray(entry.tags)) meta.tags = entry.tags;
        }
        if(!meta.family) meta.family = fallback.family || role;
        if(!meta.stack) meta.stack = fallback.stack || `'${meta.family}', sans-serif`;
        sanitized[role] = {
          id: meta.id || slugify(meta.family || role),
          family: meta.family,
          stack: meta.stack,
          css: meta.css || fallback.css || ''
        };
        if(meta.category) sanitized[role].category = meta.category;
        if(meta.weights) sanitized[role].weights = meta.weights;
        if(meta.tags) sanitized[role].tags = meta.tags;
      });
      return sanitized;
    }

    function showStatus(message){
      statusMessage.textContent = message;
    }

    function showNotice(text){
      notice.textContent = text;
      notice.classList.add('show');
      clearTimeout(showNotice.timer);
      showNotice.timer = setTimeout(()=>notice.classList.remove('show'),1400);
    }

    function computeMutedTextColor(baseTokens, aliasTokens){
      const baseText = normalizeHex(baseTokens['--text']) || '#000000';
      const background = normalizeHex(aliasTokens['--surface-primary'] || baseTokens['--bg']) || '#FFFFFF';
      // Оттеняем основной цвет за счёт фона — без искусственного повышения контраста,
      // чтобы диагностика оставалась честной и совпадала с реальными HEX-значениями профиля.
      return mixColors(baseText, background, 0.35);
    }

    function mixColors(hexA, hexB, weightB){
      const a = parseHex(hexA || '#000000');
      const b = parseHex(hexB || '#000000');
      const wb = Number.isFinite(weightB) ? weightB : 0.5;
      const wa = 1 - wb;
      const mix = {
        r:Math.round(a.r*wa + b.r*wb),
        g:Math.round(a.g*wa + b.g*wb),
        b:Math.round(a.b*wa + b.b*wb)
      };
      return rgbToHex(mix);
    }

    function parseHex(hex){
      const normalized = normalizeHex(hex) || '#000000';
      return {
        r:parseInt(normalized.slice(1,3),16),
        g:parseInt(normalized.slice(3,5),16),
        b:parseInt(normalized.slice(5,7),16)
      };
    }

    function rgbToHex({r,g,b}){
      return '#'+[r,g,b].map(v=>{
        const h=v.toString(16).toUpperCase();
        return h.length===1?'0'+h:h;
      }).join('');
    }

    function normalizeHex(value){
      if(!value) return '';
      let hex = String(value).trim();
      if(hex.startsWith('#')) hex = hex.slice(1);
      if(hex.length===3){
        hex = hex.split('').map(ch=>ch+ch).join('');
      }
      if(!/^[0-9a-fA-F]{6}$/.test(hex)) return '';
      return '#'+hex.toUpperCase();
    }

    function randomId(){
      return 'id-'+Math.random().toString(36).slice(2,8);
    }

    function cloneProfile(profile){
      return JSON.parse(JSON.stringify(profile));
    }

    function generateUniqueId(preferred){
      const cleaned = preferred && typeof preferred === 'string'
        ? preferred.trim().replace(/[^a-zA-Z0-9_-]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'')
        : '';
      const base = cleaned ? cleaned.toLowerCase() : randomId();
      let candidate = base || randomId();
      while(state.profiles.some(profile=>profile.id===candidate)){
        candidate = `${base}-${Math.random().toString(36).slice(2,6)}`;
      }
      return candidate;
    }

    function formatImportName(name){
      const base = name && String(name).trim() ? String(name).trim() : 'Импортированный профиль';
      if(base.toLowerCase().includes('импорт')) return base;
      return `${base} (импорт)`;
    }

    function structuredClone(obj){
      return JSON.parse(JSON.stringify(obj));
    }

    function calculateContrast(fg, bg){
      const l1 = relativeLuminance(parseHex(fg));
      const l2 = relativeLuminance(parseHex(bg));
      const brightest = Math.max(l1, l2);
      const darkest = Math.min(l1, l2);
      return (brightest + 0.05) / (darkest + 0.05);
    }

    function getReadableTextColor(hex){
      const luminance = relativeLuminance(parseHex(hex));
      return luminance > 0.6 ? '#1F1D2A' : '#FFFFFF';
    }

    function relativeLuminance({r,g,b}){
      const srgb = [r,g,b].map(v=>{
        const c = v/255;
        return c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055,2.4);
      });
      return srgb[0]*0.2126 + srgb[1]*0.7152 + srgb[2]*0.0722;
    }

    function loadFonts(){
      try{
        const raw = localStorage.getItem(FONT_KEY);
        if(!raw) return cloneFontMeta(DEFAULT_FONT_META);
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed.heading === 'object' && parsed.heading !== null && parsed.heading.stack){
          return {
            heading: normalizeFontMeta(parsed.heading, DEFAULT_FONT_META.heading),
            text: normalizeFontMeta(parsed.text, DEFAULT_FONT_META.text),
            ui: normalizeFontMeta(parsed.ui, DEFAULT_FONT_META.ui)
          };
        }
        return {
          heading: legacyFontMeta(parsed?.heading, DEFAULT_FONT_META.heading),
          text: legacyFontMeta(parsed?.text, DEFAULT_FONT_META.text),
          ui: legacyFontMeta(parsed?.ui, DEFAULT_FONT_META.ui)
        };
      }catch(e){
        return cloneFontMeta(DEFAULT_FONT_META);
      }
    }

    function applyFonts(fonts){
      const root = document.documentElement;
      ['heading','text','ui'].forEach(key=>{
        const meta = fonts[key] || DEFAULT_FONT_META[key];
        if(meta?.css) ensureFontLoaded(meta);
        root.style.setProperty(key==='heading'?'--font-heading':key==='text'?'--font-body':'--font-ui', meta?.stack || DEFAULT_FONT_META[key].stack);
      });
    }

    function ensureFontLoaded(font){
      if(!font?.css) return;
      const id = 'font-'+(font.id || slugify(font.family || 'font'));
      if(document.getElementById(id)) return;
      const link = document.createElement('link');
      link.id = id;
      link.rel = 'stylesheet';
      link.href = font.css;
      document.head.appendChild(link);
    }

    function cloneFontMeta(source){
      return {
        heading: source.heading ? {...source.heading} : null,
        text: source.text ? {...source.text} : null,
        ui: source.ui ? {...source.ui} : null
      };
    }

    function normalizeFontMeta(entry, fallback){
      const base = fallback ? {...fallback} : {family:'Inter', stack:"'Inter', sans-serif", css:'', id:'inter'};
      if(entry && typeof entry === 'object'){
        if(entry.id) base.id = entry.id;
        if(entry.family) base.family = entry.family;
        if(entry.stack) base.stack = entry.stack;
        if(entry.css) base.css = entry.css;
      }
      return base;
    }

    function legacyFontMeta(id, fallback){
      if(id && LEGACY_FONT_MAP[id]){
        return {...LEGACY_FONT_MAP[id]};
      }
      return {...fallback};
    }

    function slugify(value){
      return String(value).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }
  </script>
</body>
</html>
