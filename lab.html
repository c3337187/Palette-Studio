<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Цветовая лаборатория</title>
  <style>
    :root{
      --color-base:#F5F3FA;
      --color-secondary:#D6CFFE;
      --color-accent:#FFB870;
      --color-neutral:#2F2537;
      --surface-primary:var(--color-base);
      --surface-card:color-mix(in srgb,var(--color-base) 85%, white 15%);
      --surface-muted:color-mix(in srgb,var(--color-secondary) 35%, white);
      --surface-hero:color-mix(in srgb,var(--color-secondary) 60%, var(--color-accent));
      --surface-accent:color-mix(in srgb,var(--color-secondary) 70%, var(--color-neutral));
      --text-strong:var(--color-neutral);
      --text-muted:color-mix(in srgb,var(--color-neutral) 58%, var(--surface-primary) 42%);
      --border-subtle:color-mix(in srgb,var(--color-secondary) 24%, var(--color-neutral));
      --action-primary:color-mix(in srgb,var(--color-accent) 82%, var(--color-neutral));
      --action-primary-hover:color-mix(in srgb,var(--color-accent) 92%, white 8%);
      --badge-accent:color-mix(in srgb,var(--color-secondary) 55%, white);
      --ratio-primary:var(--surface-primary);
      --ratio-secondary:var(--surface-muted);
      --ratio-accent:var(--action-primary);
      --font-heading:'Manrope', 'Inter', 'Segoe UI', system-ui, sans-serif;
      --font-body:'Inter', 'Segoe UI', system-ui, sans-serif;
      --font-ui:'Manrope', 'Inter', 'Segoe UI', system-ui, sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--surface-primary),#fff 70%);color:var(--text-strong);font-family:var(--font-body);line-height:1.6;min-height:100vh;overflow-x:hidden}
    a{text-decoration:none;color:inherit}
    .topbar{background:rgba(255,255,255,0.85);backdrop-filter:blur(14px);border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:0;z-index:10}
    .topbar .container{max-width:1200px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;gap:20px}
    .brand{font-weight:700;font-size:18px;letter-spacing:0.06em;text-transform:uppercase;color:color-mix(in srgb,var(--color-neutral) 85%, white 15%)}
    .nav-links{display:flex;gap:12px;font-size:14px}
    .nav-link{padding:8px 14px;border-radius:999px;color:var(--text-muted);transition:background .2s,color .2s}
    .nav-link:hover{background:var(--surface-muted);color:var(--text-strong)}
    .nav-link.active{background:var(--action-primary);color:#fff;box-shadow:0 10px 24px rgba(76,45,110,0.2)}
    .layout{max-width:1200px;margin:0 auto;padding:40px 24px 72px;display:grid;grid-template-columns:360px 1fr;gap:28px;align-items:start}
    .sidebar{display:flex;flex-direction:column;gap:20px}
    .panel{background:var(--surface-card);border-radius:18px;padding:20px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 16px 40px rgba(54,38,70,0.12);display:flex;flex-direction:column;gap:16px}
    .panel-head{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .panel h2{margin:0;font-size:18px;font-family:var(--font-heading)}
    .panel p{margin:0;font-size:13px;color:var(--text-muted)}
    .preset-catalog{display:flex;flex-direction:column;gap:12px}
    .preset-catalog h3{margin:0;font-size:14px;font-family:var(--font-heading);text-transform:uppercase;letter-spacing:0.08em;color:color-mix(in srgb,var(--color-neutral) 82%, white 18%)}
    .preset-note{margin:0;font-size:12px;color:var(--text-muted)}
    .preset-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .preset-card{display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:14px;background:var(--surface-muted);border:1px solid rgba(0,0,0,0.05);transition:border .2s,box-shadow .2s,background .2s}
    .preset-card:hover{border-color:color-mix(in srgb,var(--color-secondary) 40%, transparent);box-shadow:0 8px 22px rgba(54,38,70,0.12)}
    .preset-card.is-active{border-color:color-mix(in srgb,var(--action-primary) 45%, transparent);box-shadow:0 8px 24px color-mix(in srgb,var(--action-primary) 22%, transparent);background:color-mix(in srgb,var(--surface-card) 82%, var(--action-primary) 18%)}
    .preset-title{font-size:13px;font-weight:600;font-family:var(--font-heading);color:var(--text-strong)}
    .preset-desc{margin:0;font-size:12px;color:var(--text-muted);line-height:1.4}
    .preset-swatches{display:flex;gap:6px}
    .preset-swatch{flex:1;height:26px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)}
    .preset-tags{display:flex;flex-wrap:wrap;gap:6px}
    .preset-tags span{padding:4px 8px;border-radius:999px;background:color-mix(in srgb,var(--surface-card) 80%, white 20%);color:color-mix(in srgb,var(--color-neutral) 70%, white 30%);font-size:10px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase}
    .preset-apply{font-size:11px;text-transform:uppercase;letter-spacing:0.08em}
    .panel-divider{height:1px;background:rgba(0,0,0,0.08);margin:4px 0 12px;border:none}
    .tab-switch{display:flex;gap:8px}
    .tab-button{padding:8px 14px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);font-size:12px;font-weight:600;color:var(--text-muted);cursor:pointer;transition:background .2s,color .2s,box-shadow .2s;font-family:var(--font-ui);text-transform:uppercase;letter-spacing:0.05em}
    .tab-button:hover{background:var(--surface-muted);color:var(--text-strong)}
    .tab-button.active{background:var(--action-primary);color:#fff;border-color:var(--action-primary);box-shadow:0 10px 26px rgba(76,45,110,0.18)}
    .tab-panel{display:none;margin-top:16px}
    .tab-panel.active{display:block}
    .profile-manage{display:flex;flex-direction:column;gap:16px}
    .profile-head{display:flex;flex-direction:column;gap:12px}
    .profile-select{display:flex;flex-direction:column;gap:10px}
    .profile-select select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.12);font-size:14px;background:#fff;color:var(--text-strong)}
    .profile-actions{display:flex;flex-wrap:wrap;gap:8px}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);color:var(--text-strong);font-size:13px;font-family:var(--font-ui);cursor:pointer;transition:background .2s,box-shadow .2s}
    .btn:hover{background:var(--surface-muted)}
    .btn.danger{background:color-mix(in srgb,var(--color-accent) 18%, white);border-color:color-mix(in srgb,var(--color-accent) 28%, white);color:color-mix(in srgb,var(--color-accent) 60%, var(--color-neutral) 40%)}
    .btn:disabled{opacity:0.55;cursor:not-allowed;box-shadow:none}
    .status{font-size:12px;color:var(--text-muted)}
    .token-controls{display:flex;flex-direction:column;gap:0}
    .token-row{display:grid;grid-template-columns:150px 1fr;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.05)}
    .token-row:last-child{border-bottom:none}
    .token-label{display:flex;flex-direction:column;gap:4px}
    .token-label .name{font-size:13px;font-weight:600;color:var(--text-strong)}
    .token-label .var{font-family:monospace;font-size:11px;color:color-mix(in srgb,var(--color-secondary) 55%, var(--color-neutral) 45%)}
    .token-inputs{display:flex;gap:8px;align-items:center}
    .token-inputs input[type="color"]{width:40px;height:36px;border:none;background:none;padding:0;cursor:pointer}
    .token-inputs input[type="text"]{width:96px;padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-family:monospace;text-transform:uppercase;font-size:13px;color:var(--text-strong)}
    .token-inputs input[type="text"].invalid{border-color:color-mix(in srgb,var(--color-accent) 45%, var(--color-neutral) 55%);box-shadow:0 0 0 2px color-mix(in srgb,var(--color-accent) 30%, transparent)}
    .alias-controls{display:flex;flex-direction:column}
    .alias-row{display:grid;grid-template-columns:150px 1fr 56px;align-items:start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.05)}
    .alias-row:last-child{border-bottom:none}
    .alias-label{display:flex;flex-direction:column;gap:4px}
    .alias-label .name{font-size:13px;font-weight:600;color:var(--text-strong)}
    .alias-label .var{font-family:monospace;font-size:11px;color:color-mix(in srgb,var(--color-secondary) 55%, var(--color-neutral) 45%)}
    .alias-control{display:flex;flex-direction:column;gap:8px}
    .alias-control select{width:100%;padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:13px;background:#fff;color:var(--text-strong)}
    .alias-custom{display:flex;gap:8px;align-items:center}
    .alias-custom input[type="color"]{width:36px;height:32px;border:none;padding:0;cursor:pointer;background:none}
    .alias-custom input[type="text"]{width:90px;padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-family:monospace;text-transform:uppercase;font-size:13px}
    .alias-custom input[type="text"].invalid{border-color:color-mix(in srgb,var(--color-accent) 45%, var(--color-neutral) 55%);box-shadow:0 0 0 2px color-mix(in srgb,var(--color-accent) 30%, transparent)}
    .alias-preview{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)}
    .alias-preview .swatch{width:48px;height:48px;border-radius:12px;border:1px solid rgba(0,0,0,0.05)}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    .generator-form{display:flex;flex-direction:column;gap:14px}
    .generator-row{display:flex;gap:10px;align-items:center}
    .generator-row input[type="text"]{flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:13px;font-family:var(--font-ui)}
    .generator-row input[type="text"].invalid{border-color:color-mix(in srgb,var(--color-accent) 45%, var(--color-neutral) 55%);box-shadow:0 0 0 2px color-mix(in srgb,var(--color-accent) 30%, transparent)}
    .generator-row input[type="color"]{width:40px;height:36px;border:none;background:none;padding:0;cursor:pointer}
    .generator-actions{display:flex;gap:10px;flex-wrap:wrap}
    .generator-status{font-size:12px;color:var(--text-muted);min-height:16px}
    .preview{display:flex;flex-direction:column;gap:24px}
    .preview header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .preview header h1{margin:0;font-size:26px;font-family:var(--font-heading)}
    .preview header p{margin:6px 0 0;color:var(--text-muted);max-width:520px}
    .profile-chip{padding:6px 12px;border-radius:999px;background:var(--surface-muted);font-size:12px;color:var(--text-strong);font-family:var(--font-ui)}
    .contrast-card{background:var(--surface-card);border:1px solid var(--border-subtle);border-radius:16px;padding:16px;min-width:240px;box-shadow:0 10px 28px rgba(54,38,70,0.08);display:flex;flex-direction:column;gap:10px}
    .contrast-card h2{margin:0;font-size:16px;font-family:var(--font-heading)}
    .contrast-card p{margin:0;font-size:12px;color:var(--text-muted);line-height:1.5}
    .contrast-list{display:flex;flex-direction:column;gap:8px;font-size:13px}
    .contrast-item{display:flex;flex-direction:column;gap:8px;padding:10px 12px;border-radius:12px;background:var(--surface-muted);border:1px solid rgba(0,0,0,0.05);transition:border .2s,box-shadow .2s}
    .contrast-item.pass{border-color:color-mix(in srgb,var(--color-secondary) 45%, var(--color-neutral) 15%);box-shadow:0 8px 18px color-mix(in srgb,var(--color-secondary) 25%, transparent)}
    .contrast-item.warn{border-color:color-mix(in srgb,var(--color-accent) 45%, var(--color-secondary) 15%);box-shadow:0 6px 16px color-mix(in srgb,var(--color-accent) 20%, transparent)}
    .contrast-item.fail{border-color:color-mix(in srgb,var(--color-accent) 60%, var(--color-neutral) 20%);box-shadow:0 6px 14px color-mix(in srgb,var(--color-accent) 25%, transparent)}
    .contrast-item .combo{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .contrast-item .combo .swatch{width:52px;height:32px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;font-weight:700;font-family:var(--font-ui)}
    .contrast-item .ratio{font-family:monospace;font-weight:600}
    .contrast-item .badge{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:600}
    .contrast-item.pass .badge{background:color-mix(in srgb,var(--color-secondary) 35%, white);color:color-mix(in srgb,var(--color-secondary) 72%, var(--color-neutral) 28%)}
    .contrast-item.warn .badge{background:color-mix(in srgb,var(--color-accent) 32%, white);color:color-mix(in srgb,var(--color-accent) 70%, var(--color-neutral) 30%)}
    .contrast-item.fail .badge{background:color-mix(in srgb,var(--color-accent) 48%, var(--color-neutral));color:color-mix(in srgb,var(--color-accent) 78%, var(--color-neutral) 22%)}
    .contrast-item .guide{font-size:11px;color:var(--text-muted)}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
    .preview-panel{background:var(--surface-card);border-radius:18px;padding:20px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 12px 34px rgba(54,38,70,0.1);display:flex;flex-direction:column;gap:14px}
    .preview-panel header{display:flex;justify-content:space-between;align-items:center}
    .preview-panel header h3{margin:0;font-size:16px;font-family:var(--font-heading)}
    .tag{padding:4px 10px;border-radius:999px;font-size:11px;background:var(--badge-accent);color:var(--text-strong);font-weight:600;text-transform:uppercase;letter-spacing:0.06em}
    .hero-demo{border-radius:14px;padding:24px;background:linear-gradient(135deg,var(--surface-hero),var(--action-primary));color:#fff;display:flex;flex-direction:column;gap:12px;box-shadow:0 16px 42px rgba(0,0,0,0.2)}
    .hero-demo .cta{align-self:flex-start;padding:10px 18px;border-radius:12px;border:none;background:var(--action-primary);color:#fff;font-family:var(--font-ui);font-weight:600;cursor:pointer}
    .hero-demo .cta:hover{background:var(--action-primary-hover)}
    .nav-demo{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:14px;background:var(--surface-muted);border:1px solid var(--border-subtle)}
    .nav-demo .links{display:flex;gap:14px;color:var(--text-muted)}
    .button-stack{display:flex;flex-direction:column;gap:10px}
    .button-stack button{padding:10px 18px;border-radius:12px;border:none;background:var(--action-primary);color:#fff;font-weight:600;font-family:var(--font-ui);box-shadow:0 8px 22px rgba(0,0,0,0.12)}
    .button-stack button[data-state="hover"]{background:var(--action-primary-hover)}
    .button-stack button[data-state="ghost"]{background:var(--surface-card);color:var(--text-strong);border:1px solid var(--border-subtle);box-shadow:none}
    .card-list{display:flex;flex-direction:column;gap:12px}
    .sample-card{padding:16px;border-radius:16px;border:1px solid var(--border-subtle);background:var(--surface-card);display:grid;gap:10px}
    .sample-card h4{margin:0;font-size:15px;font-family:var(--font-heading)}
    .sample-card p{margin:0;color:var(--text-muted);font-size:14px}
    .sample-card .meta{display:flex;justify-content:space-between;align-items:center;color:var(--text-muted);font-size:12px}
    .badge-small{padding:4px 8px;border-radius:999px;background:var(--badge-accent);font-size:11px;font-weight:600;color:var(--text-strong)}
    .form{display:flex;flex-direction:column;gap:12px}
    .form label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
    .form input{padding:10px 12px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);color:var(--text-strong);font-family:var(--font-body)}
    .form input:focus{outline:2px solid color-mix(in srgb,var(--action-primary) 35%,transparent);border-color:var(--action-primary)}
    .form-actions{display:flex;gap:10px;flex-wrap:wrap}
    .ratio-demo{display:flex;flex-direction:column;gap:12px}
    .ratio-bar{display:flex;height:44px;border-radius:16px;overflow:hidden;border:1px solid rgba(0,0,0,0.08);box-shadow:inset 0 -6px 18px rgba(0,0,0,0.05)}
    .ratio-bar span{display:flex;align-items:center;justify-content:center;font-weight:600;font-family:var(--font-ui);font-size:13px}
    .ratio-legend{display:flex;gap:14px;flex-wrap:wrap;font-size:12px;color:var(--text-muted)}
    .ratio-legend span{display:flex;align-items:center;gap:6px}
    .ratio-dot{width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,0.12)}
    .notice{position:fixed;right:24px;bottom:24px;padding:12px 16px;border-radius:12px;background:var(--text-strong);color:#fff;font-size:13px;opacity:0;transform:translateY(12px);transition:all .3s}
    .notice.show{opacity:1;transform:translateY(0)}
    @media(max-width:1100px){
      .layout{grid-template-columns:1fr}
    }
    @media(max-width:720px){
      .layout{padding:32px 16px 56px}
      .token-row,.alias-row{grid-template-columns:1fr}
      .alias-preview{display:none}
      .preview header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="brand">Palette Studio</div>
      <nav class="nav-links">
        <a class="nav-link" href="index.html">Палитра</a>
        <a class="nav-link active" href="lab.html">Лаборатория</a>
        <a class="nav-link" href="fonts.html">Шрифты</a>
      </nav>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <section class="panel">
        <div class="panel-head">
          <div class="profile-head">
            <h2>Профили палитры</h2>
            <p>Создавайте, копируйте и настраивайте цветовые профили. Изменения сохраняются автоматически.</p>
          </div>
          <div class="tab-switch" role="tablist" data-tab-group="profiles">
            <button class="tab-button active" type="button" data-tab="active" aria-selected="true" tabindex="0">Активные</button>
            <button class="tab-button" type="button" data-tab="standard" aria-selected="false" tabindex="-1">Стандарт</button>
          </div>
        </div>
        <div class="tab-panel active" data-panel="active" data-tab-group="profiles" role="tabpanel" aria-hidden="false">
          <div class="profile-manage">
            <div class="profile-select">
              <label style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:color-mix(in srgb,var(--color-neutral) 85%, white 15%)">Активный профиль</label>
              <select id="profileSelect"></select>
            </div>
            <div class="panel-divider" aria-hidden="true"></div>
            <div class="profile-actions">
              <button class="btn" id="duplicateProfile">Создать копию</button>
              <button class="btn" id="renameProfile">Переименовать</button>
              <button class="btn danger" id="deleteProfile">Удалить</button>
              <button class="btn danger" id="purgeProfiles">Очистить профили</button>
              <button class="btn" id="resetProfile">Сбросить цвета</button>
            </div>
            <div class="status" id="statusMessage">Готово к редактированию.</div>
          </div>
        </div>
        <div class="tab-panel" data-panel="standard" data-tab-group="profiles" role="tabpanel" hidden aria-hidden="true">
          <div class="preset-catalog">
            <p class="preset-note">10 трендовых профилей на базе аналитики 2024 года. Добавьте любой, чтобы сделать его активным и донастроить под проект.</p>
            <div class="preset-grid" id="presetGrid"></div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <div>
            <h2>Генератор 60/30/10</h2>
            <p>Введите основной цвет, и утилита предложит гармоничную палитру, распределённую по правилу 60-30-10.</p>
          </div>
        </div>
        <div class="generator-form" id="generatorForm">
          <div class="generator-row">
            <input type="color" id="generatorColor" value="#FFB870" aria-label="Основной цвет" />
            <input type="text" id="generatorHex" value="#FFB870" placeholder="#RRGGBB" aria-label="HEX основного цвета" />
          </div>
          <input type="text" id="generatorName" placeholder="Название нового профиля" aria-label="Название профиля" />
          <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-muted)">
            <input type="checkbox" id="generatorApplyFonts" checked style="width:auto;height:auto" />
            Применить предложенные шрифты из генератора
          </label>
          <div class="generator-actions">
            <button type="button" class="btn" id="generatorCreate">Создать профиль</button>
            <a class="btn" href="#distributionPanel">Показать распределение</a>
          </div>
          <div class="generator-status" id="generatorStatus">Сгенерируйте профиль из основного цвета.</div>
        </div>
      </section>

      <section class="panel" id="colorsPanel">
        <div class="panel-head">
          <div>
            <h2>Цветовые токены</h2>
            <p>Управляйте базовыми значениями и alias-переменными в одном месте.</p>
          </div>
          <div class="tab-switch" role="tablist" data-tab-group="tokens">
            <button class="tab-button active" type="button" data-tab="base" aria-selected="true" tabindex="0">Базовые</button>
            <button class="tab-button" type="button" data-tab="alias" aria-selected="false" tabindex="-1">Alias</button>
          </div>
        </div>
        <div class="tab-panel active" data-panel="base" data-tab-group="tokens" role="tabpanel" aria-hidden="false">
          <div class="token-controls" id="baseControls"></div>
        </div>
        <div class="tab-panel" data-panel="alias" data-tab-group="tokens" role="tabpanel" hidden aria-hidden="true">
          <div class="alias-controls" id="aliasControls"></div>
        </div>
      </section>

      <section class="panel">
        <div>
          <h2>Экспорт</h2>
          <p>Быстрый обмен с командой: скопируйте CSS или сохраните JSON-файл.</p>
        </div>
        <div class="actions">
          <button class="btn" id="copyCss">Скопировать CSS</button>
          <button class="btn" id="exportJson">Экспорт JSON</button>
          <button class="btn" id="importJson">Импорт JSON</button>
          <button class="btn" id="importText">Вставить конфиг</button>
        </div>
      </section>
    </aside>

    <section class="preview">
      <header>
        <div>
          <h1>Лайв-превью</h1>
          <p>Компоненты справа используют активный профиль и выбранные шрифты. Тестируйте сценарии до внедрения в проект.</p>
          <div class="profile-chip" id="previewProfile">—</div>
        </div>
        <div class="contrast-card">
          <h2>Контраст</h2>
          <p>Ориентируйтесь на WCAG: для обычного текста контраст ≥4.5 (AA) и ≥7.0 (AAA), для крупного текста — ≥3.0 и ≥4.5 соответственно.</p>
          <div class="contrast-list" id="contrastList"></div>
        </div>
      </header>

      <div class="preview-grid">
        <div class="preview-panel" id="distributionPanel">
          <header>
            <h3>Правило 60/30/10</h3>
            <span class="tag">Guideline</span>
          </header>
          <div class="ratio-demo">
            <div class="ratio-bar">
              <span data-ratio="primary">60%</span>
              <span data-ratio="secondary">30%</span>
              <span data-ratio="accent">10%</span>
            </div>
            <div class="ratio-legend">
              <span><span class="ratio-dot" data-ratio-dot="primary"></span>Основной</span>
              <span><span class="ratio-dot" data-ratio-dot="secondary"></span>Вторичный</span>
              <span><span class="ratio-dot" data-ratio-dot="accent"></span>Акцент</span>
            </div>
            <p style="margin:0;font-size:12px;color:var(--text-muted)">Распределяйте площади интерфейса: основной фон занимает ~60%, вторичный поддерживает блоки (~30%), а акцент подчеркивает ключевые точки (~10%).</p>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Hero</h3>
            <span class="tag">Витрина</span>
          </header>
          <div class="hero-demo">
            <span style="font-size:13px;letter-spacing:0.08em;text-transform:uppercase;opacity:0.75">Команда продукта</span>
            <div style="font-size:26px;font-weight:700;font-family:var(--font-heading);line-height:1.2">Создавайте интерфейсы быстрее</div>
            <p style="margin:0;font-size:14px;opacity:0.85">Комбинируйте оттенки, проверяйте контраст и экспортируйте результат.</p>
            <button class="cta">Подробнее</button>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Навигация</h3>
            <span class="tag">Layout</span>
          </header>
          <div class="nav-demo">
            <div style="font-weight:700;font-family:var(--font-heading)">Логотип</div>
            <div class="links">
              <span>Главная</span>
              <span>Продукт</span>
              <span>Контакты</span>
            </div>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Кнопки</h3>
            <span class="tag">CTA</span>
          </header>
          <div class="button-stack">
            <button>Primary</button>
            <button data-state="hover">Hover</button>
            <button data-state="ghost">Ghost</button>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Карточки</h3>
            <span class="tag">Content</span>
          </header>
          <div class="card-list">
            <div class="sample-card">
              <h4>Гайд по цветам</h4>
              <p>Пример карточки, использующей текущие переменные.</p>
              <div class="meta"><span>3 часа назад</span><span class="badge-small">UI Kit</span></div>
            </div>
            <div class="sample-card">
              <h4>Обновление 2.0</h4>
              <p>Синхронизация палитры, alias и шрифтов.</p>
              <div class="meta"><span>Дизайн-команда</span><span class="badge-small">Release</span></div>
            </div>
          </div>
        </div>
        <div class="preview-panel">
          <header>
            <h3>Форма</h3>
            <span class="tag">Input</span>
          </header>
          <form class="form" onsubmit="return false">
            <label for="preview-name">Имя</label>
            <input id="preview-name" type="text" placeholder="Введите имя" />
            <label for="preview-email">Email</label>
            <input id="preview-email" type="email" placeholder="name@example.com" />
            <div class="form-actions">
              <button class="btn" style="background:var(--action-primary);color:#fff;border:none">Отправить</button>
              <button class="btn" type="button">Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <div class="notice" id="notice"></div>
  <input type="file" id="importInput" accept="application/json" hidden />
  <script src="palette-store.js"></script>
  <script src="palette-generator.js"></script>
  <script>
    const FONT_KEY = 'palette-studio-fonts';

    const {
      BASE_TOKENS,
      ALIAS_DEFS,
      loadState,
      hydrateState,
      saveState: persistState,
      resolveAliases,
      applyPalette,
      mixColors,
      normalizeHex,
      normalizeProfile,
      getStandardPresets,
      randomId,
      clone
    } = PaletteStore;

    const cloneProfile = profile => clone(profile);

    const LEGACY_FONT_OPTIONS = [
      {id:'manrope', label:'Manrope', stack:"'Manrope', sans-serif", link:'https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'inter', label:'Inter', stack:"'Inter', sans-serif", link:'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'rubik', label:'Rubik', stack:"'Rubik', sans-serif", link:'https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'montserrat', label:'Montserrat', stack:"'Montserrat', sans-serif", link:'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'nunito', label:'Nunito', stack:"'Nunito', sans-serif", link:'https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'raleway', label:'Raleway', stack:"'Raleway', sans-serif", link:'https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'pt-sans', label:'PT Sans', stack:"'PT Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap&subset=cyrillic'},
      {id:'pt-serif', label:'PT Serif', stack:"'PT Serif', serif", link:'https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap&subset=cyrillic'},
      {id:'playfair', label:'Playfair Display', stack:"'Playfair Display', serif", link:'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'lora', label:'Lora', stack:"'Lora', serif", link:'https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'fira-sans', label:'Fira Sans', stack:"'Fira Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'noto-sans', label:'Noto Sans', stack:"'Noto Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'noto-serif', label:'Noto Serif', stack:"'Noto Serif', serif", link:'https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'source-sans', label:'Source Sans 3', stack:"'Source Sans 3', sans-serif", link:'https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'ibm-plex', label:'IBM Plex Sans', stack:"'IBM Plex Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap&subset=cyrillic'},
      {id:'open-sans', label:'Open Sans', stack:"'Open Sans', sans-serif", link:'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap&subset=cyrillic'},
      {id:'roboto', label:'Roboto', stack:"'Roboto', sans-serif", link:'https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap&subset=cyrillic'},
      {id:'ubuntu', label:'Ubuntu', stack:"'Ubuntu', sans-serif", link:'https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap&subset=cyrillic'},
      {id:'exo2', label:'Exo 2', stack:"'Exo 2', sans-serif", link:'https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700&display=swap&subset=cyrillic'},
      {id:'spectral', label:'Spectral', stack:"'Spectral', serif", link:'https://fonts.googleapis.com/css2?family=Spectral:wght@400;500;600;700&display=swap&subset=cyrillic'}
    ];
    const LEGACY_FONT_MAP = Object.fromEntries(LEGACY_FONT_OPTIONS.map(font=>[font.id,{id:font.id,family:font.label,stack:font.stack,css:font.link}]));
    const DEFAULT_FONT_META = {
      heading:{...LEGACY_FONT_MAP.manrope},
      text:{...LEGACY_FONT_MAP.inter},
      ui:{...LEGACY_FONT_MAP.manrope}
    };

    const profileSelect = document.getElementById('profileSelect');
    const baseControls = document.getElementById('baseControls');
    const aliasControls = document.getElementById('aliasControls');
    const statusMessage = document.getElementById('statusMessage');
    const previewProfile = document.getElementById('previewProfile');
    const contrastList = document.getElementById('contrastList');
    const notice = document.getElementById('notice');
    const importInput = document.getElementById('importInput');
    const presetGrid = document.getElementById('presetGrid');
    const generatorColor = document.getElementById('generatorColor');
    const generatorHex = document.getElementById('generatorHex');
    const generatorName = document.getElementById('generatorName');
    const generatorApplyFonts = document.getElementById('generatorApplyFonts');
    const generatorCreate = document.getElementById('generatorCreate');
    const generatorStatus = document.getElementById('generatorStatus');
    const ratioSegments = document.querySelectorAll('[data-ratio]');
    const ratioDots = document.querySelectorAll('[data-ratio-dot]');
    const tabSwitches = document.querySelectorAll('.tab-switch');

    const duplicateBtn = document.getElementById('duplicateProfile');
    const renameBtn = document.getElementById('renameProfile');
    const deleteBtn = document.getElementById('deleteProfile');
    const purgeBtn = document.getElementById('purgeProfiles');
    const resetBtn = document.getElementById('resetProfile');
    const copyCssBtn = document.getElementById('copyCss');
    const exportBtn = document.getElementById('exportJson');
    const importBtn = document.getElementById('importJson');
    const importTextBtn = document.getElementById('importText');

    let state = loadState();
    let activeProfile = state.profiles.find(p=>p.id===state.activeId) || state.profiles[0];
    const standardPresets = getStandardPresets();
    const aliasKeys = ALIAS_DEFS.map(def=>def.variable);

    let fonts = loadFonts();
    applyFonts(fonts);
    applyPalette(activeProfile);

    initProfileSelect();
    setupTabs();
    setupGenerator();
    buildBaseControls();
    renderAliasControls();
    renderPreview();
    renderPresetCatalog();

    profileSelect.addEventListener('change', e=>{
      setActiveProfile(e.target.value);
      showStatus('Профиль переключён');
    });

    duplicateBtn.addEventListener('click', ()=>{
      const clone = cloneProfile(activeProfile);
      clone.id = randomId();
      clone.name = `${activeProfile.name} (копия)`;
      state.profiles.push(clone);
      setActiveProfile(clone.id);
      saveState();
      initProfileSelect();
      showStatus('Создана копия профиля');
    });

    renameBtn.addEventListener('click', ()=>{
      const name = prompt('Введите новое название профиля', activeProfile.name);
      if(!name) return;
      activeProfile.name = name.trim().substring(0,60) || activeProfile.name;
      saveState();
      initProfileSelect();
      renderPreview();
      renderPresetCatalog();
      showStatus('Название обновлено');
    });

    deleteBtn.addEventListener('click', ()=>{
      if(state.profiles.length<=1){
        alert('Нельзя удалить единственный профиль.');
        return;
      }
      if(!confirm('Удалить текущий профиль?')) return;
      state.profiles = state.profiles.filter(p=>p.id!==activeProfile.id);
      state.activeId = state.profiles[0].id;
      activeProfile = state.profiles[0];
      applyPalette(activeProfile);
      saveState();
      initProfileSelect();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();
      showStatus('Профиль удалён');
    });

    purgeBtn.addEventListener('click', ()=>{
      if(!confirm('Удалить все профили, кроме активного?')) return;
      const preserved = cloneProfile(activeProfile);
      preserved.id = 'main';
      preserved.name = 'main';
      const normalized = normalizeProfile(preserved);
      state.profiles = [normalized];
      state.activeId = normalized.id;
      activeProfile = state.profiles[0];
      applyPalette(activeProfile);
      saveState();
      initProfileSelect();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();
      showStatus('Список профилей очищен');
      showNotice('Оставлен только профиль main');
    });

    resetBtn.addEventListener('click', ()=>{
      activeProfile.base = Object.fromEntries(BASE_TOKENS.map(token=>[token.variable, token.default]));
      activeProfile.aliases = {};
      applyPalette(activeProfile);
      saveState();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();
      showStatus('Цвета сброшены к умолчанию');
    });

    copyCssBtn.addEventListener('click', ()=>{
      const css = buildCssSnippet(activeProfile);
      navigator.clipboard?.writeText(css).then(()=>showNotice('CSS скопирован')).catch(()=>alert('Не удалось скопировать CSS'));
    });

    exportBtn.addEventListener('click', ()=>{
      const bundle = buildExportPayload();
      const data = JSON.stringify(bundle, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'palette-profiles.json';
      a.click();
      URL.revokeObjectURL(url);
      showStatus('Экспортировано в JSON');
    });

    importBtn.addEventListener('click', ()=>importInput.click());

    importTextBtn.addEventListener('click', ()=>{
      const raw = prompt('Вставьте JSON-конфиг профилей и шрифтов', '');
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        handleImportPayload(parsed);
      }catch(err){
        alert('Не удалось обработать конфиг. Проверьте JSON.');
      }
    });

    importInput.addEventListener('change', event=>{
      const file = event.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const parsed = JSON.parse(e.target.result);
          handleImportPayload(parsed);
        }catch(err){
          alert('Не удалось импортировать файл.');
        }
        importInput.value='';
      };
      reader.readAsText(file);
    });

    function handleImportPayload(payload){
      if(!payload || !Array.isArray(payload.profiles)){
        throw new Error('Некорректный формат профиля');
      }
      const hydrated = hydrateState(payload);
      const importedProfiles = hydrated.profiles;
      if(!importedProfiles.length){
        throw new Error('В конфиге отсутствуют профили');
      }

      let added = 0;
      let updated = 0;
      const idMap = new Map();

      importedProfiles.forEach(profile=>{
        const existingIndex = state.profiles.findIndex(p=>p.id===profile.id);
        let finalProfile = cloneProfile(profile);

        if(existingIndex>=0){
          state.profiles[existingIndex] = finalProfile;
          updated++;
        }else{
          if(!finalProfile.id || state.profiles.some(p=>p.id===finalProfile.id)){
            finalProfile = {
              ...finalProfile,
              id: generateUniqueId(finalProfile.id),
              name: formatImportName(finalProfile.name)
            };
          }
          state.profiles.push(finalProfile);
          added++;
        }

        idMap.set(profile.id, finalProfile.id);
      });

      const preferredActive = idMap.get(hydrated.activeId) || hydrated.activeId;
      if(preferredActive && state.profiles.some(p=>p.id===preferredActive)){
        state.activeId = preferredActive;
      }

      activeProfile = state.profiles.find(p=>p.id===state.activeId) || state.profiles[0];
      applyPalette(activeProfile);
      saveState();
      initProfileSelect();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();

      const fontsApplied = applyFontPayload(payload.fonts);
      const statusParts = [];
      if(added) statusParts.push(`Добавлено профилей: ${added}`);
      if(updated) statusParts.push(`Обновлено профилей: ${updated}`);
      if(fontsApplied) statusParts.push('Шрифты обновлены');
      if(!statusParts.length) statusParts.push('Импорт выполнен');
      showStatus(statusParts.join('. '));
      showNotice(`Импортировано профилей: ${added+updated}` + (fontsApplied ? ' и шрифты' : ''));
    }

    function initProfileSelect(){
      profileSelect.innerHTML='';
      state.profiles.forEach(profile=>{
        const option = document.createElement('option');
        option.value = profile.id;
        option.textContent = profile.name;
        if(profile.id===activeProfile.id) option.selected = true;
        profileSelect.appendChild(option);
      });
    }

    function buildBaseControls(){
      baseControls.innerHTML='';
      BASE_TOKENS.forEach(token=>{
        const row = document.createElement('div');
        row.className = 'token-row';
        row.dataset.variable = token.variable;

        const label = document.createElement('div');
        label.className = 'token-label';
        label.innerHTML = `<span class="name">${token.label}</span><span class="var">${token.variable}</span>`;

        const inputs = document.createElement('div');
        inputs.className = 'token-inputs';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = activeProfile.base[token.variable];
        colorInput.addEventListener('input', ()=>{
          const value = normalizeHex(colorInput.value);
          if(!value) return;
          activeProfile.base[token.variable] = value;
          hexInput.value = value;
          hexInput.classList.remove('invalid');
          afterBaseUpdate();
        });

        const hexInput = document.createElement('input');
        hexInput.type = 'text';
        hexInput.value = activeProfile.base[token.variable];
        hexInput.maxLength = 7;
        hexInput.addEventListener('input', ()=>{
          const normalized = normalizeHex(hexInput.value);
          if(normalized){
            hexInput.classList.remove('invalid');
            if(normalized !== activeProfile.base[token.variable]){
              activeProfile.base[token.variable] = normalized;
              colorInput.value = normalized;
              afterBaseUpdate();
            }
          }else{
            hexInput.classList.add('invalid');
          }
        });
        hexInput.addEventListener('blur', ()=>{
          const normalized = normalizeHex(hexInput.value) || activeProfile.base[token.variable];
          hexInput.value = normalized;
          hexInput.classList.remove('invalid');
        });

        inputs.append(colorInput, hexInput);

        row.append(label, inputs);
        baseControls.appendChild(row);
      });
    }

    function renderAliasControls(){
      aliasControls.innerHTML='';
      const resolved = resolveAliases(activeProfile);
      ALIAS_DEFS.forEach(def=>{
        const config = activeProfile.aliases[def.variable] || def.defaultConfig();
        const row = document.createElement('div');
        row.className = 'alias-row';
        row.dataset.alias = def.variable;

        const label = document.createElement('div');
        label.className = 'alias-label';
        label.innerHTML = `<span class="name">${def.label}</span><span class="var">${def.variable}</span>`;

        const control = document.createElement('div');
        control.className = 'alias-control';

        const select = document.createElement('select');
        BASE_TOKENS.forEach(token=>{
          const option = document.createElement('option');
          option.value = `base|${token.variable}`;
          option.textContent = `Токен: ${token.label}`;
          if(config.mode==='base' && config.ref===token.variable){
            option.selected = true;
          }
          select.appendChild(option);
        });
        if(def.defaultConfig().mode==='auto' || typeof def.auto==='function'){
          const option = document.createElement('option');
          option.value = 'auto';
          option.textContent = 'Авто (зависит от базовых)';
          if(config.mode==='auto') option.selected = true;
          select.appendChild(option);
        }
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = 'Пользовательский HEX';
        if(config.mode==='custom') customOption.selected = true;
        select.appendChild(customOption);

        const custom = document.createElement('div');
        custom.className = 'alias-custom';
        const customColor = document.createElement('input');
        customColor.type = 'color';
        const customHex = document.createElement('input');
        customHex.type = 'text';
        customHex.maxLength = 7;
        const fallback = config.mode==='custom' && config.value ? config.value : resolved[def.variable];
        customColor.value = fallback;
        customHex.value = fallback;
        if(config.mode!=='custom') custom.style.display='none';

        customHex.addEventListener('input', ()=>{
          const normalized = normalizeHex(customHex.value);
          if(normalized){
            customHex.classList.remove('invalid');
            customColor.value = normalized;
            setAliasConfig(def.variable,{mode:'custom', value:normalized});
          }else{
            customHex.classList.add('invalid');
          }
        });
        customHex.addEventListener('blur', ()=>{
          const normalized = normalizeHex(customHex.value);
          if(normalized){
            customHex.value = normalized;
          }else{
            const current = activeProfile.aliases[def.variable]?.value || resolved[def.variable];
            customHex.value = current;
            customHex.classList.remove('invalid');
          }
        });
        customColor.addEventListener('input', ()=>{
          const value = normalizeHex(customColor.value);
          if(!value) return;
          customHex.value = value;
          customHex.classList.remove('invalid');
          setAliasConfig(def.variable,{mode:'custom', value:value});
        });

        select.addEventListener('change', ()=>{
          const value = select.value;
          if(value.startsWith('base|')){
            const ref = value.split('|')[1];
            setAliasConfig(def.variable,{mode:'base', ref});
            custom.style.display='none';
          }else if(value==='auto'){
            setAliasConfig(def.variable,{mode:'auto'});
            custom.style.display='none';
          }else{
            const current = activeProfile.aliases[def.variable]?.value || resolved[def.variable];
            customHex.value = current;
            customColor.value = current;
            custom.style.display='flex';
            setAliasConfig(def.variable,{mode:'custom', value:current});
          }
        });

        custom.append(customColor, customHex);
        control.append(select, custom);

        const preview = document.createElement('div');
        preview.className = 'alias-preview';
        const swatch = document.createElement('div');
        swatch.className = 'swatch';
        swatch.style.background = resolved[def.variable];
        const value = document.createElement('span');
        value.textContent = resolved[def.variable];
        preview.append(swatch, value);

        row.append(label, control, preview);
        aliasControls.appendChild(row);
      });
    }

    function setupTabs(){
      if(!tabSwitches.length) return;
      tabSwitches.forEach(group=>{
        const groupId = group.dataset.tabGroup || '';
        const buttons = group.querySelectorAll('.tab-button');
        const panels = groupId
          ? document.querySelectorAll(`.tab-panel[data-tab-group="${groupId}"]`)
          : document.querySelectorAll('.tab-panel:not([data-tab-group])');

        buttons.forEach(button=>{
          button.addEventListener('click', ()=>{
            const target = button.dataset.tab;
            buttons.forEach(btn=>{
              const isActive = btn===button;
              btn.classList.toggle('active', isActive);
              btn.setAttribute('aria-selected', isActive);
              btn.setAttribute('tabindex', isActive ? '0' : '-1');
            });
            panels.forEach(panel=>{
              const isActive = panel.dataset.panel===target;
              panel.classList.toggle('active', isActive);
              panel.toggleAttribute('hidden', !isActive);
              panel.setAttribute('aria-hidden', (!isActive).toString());
            });
          });
        });
      });
    }

    function setupGenerator(){
      if(!generatorCreate || !generatorHex || !generatorColor) return;
      if(!window.PaletteGenerator || typeof window.PaletteGenerator.generatePalette !== 'function'){
        generatorCreate.disabled = true;
        generatorStatus.textContent = 'Модуль генератора не загрузился.';
        return;
      }
      const {generatePalette} = window.PaletteGenerator;
      const initial = normalizeHex(generatorHex.value || generatorColor.value) || '#FFB870';
      generatorHex.value = initial;
      generatorColor.value = initial.toLowerCase();

      generatorColor.addEventListener('input', ()=>{
        const normalized = normalizeHex(generatorColor.value);
        generatorHex.value = normalized || generatorColor.value;
        generatorHex.classList.toggle('invalid', !normalized);
      });

      generatorHex.addEventListener('input', ()=>{
        generatorHex.classList.remove('invalid');
      });

      generatorHex.addEventListener('blur', ()=>{
        const normalized = normalizeHex(generatorHex.value);
        if(normalized){
          generatorHex.value = normalized;
          generatorColor.value = normalized.toLowerCase();
          generatorHex.classList.remove('invalid');
        }else{
          generatorHex.classList.add('invalid');
        }
      });

      generatorCreate.addEventListener('click', ()=>{
        const baseHex = normalizeHex(generatorHex.value || generatorColor.value);
        if(!baseHex){
          generatorHex.classList.add('invalid');
          generatorStatus.textContent = 'Введите HEX в формате #RRGGBB.';
          return;
        }
        try{
          generatorHex.classList.remove('invalid');
          const result = generatePalette(baseHex);
          const nameInput = generatorName?.value?.trim();
          const profileName = nameInput || buildGeneratorName(result, baseHex);
          const profile = buildProfileFromGenerated(result, profileName);
          state.profiles.push(profile);
          setActiveProfile(profile.id);
          initProfileSelect();
          generatorName.value = '';
          const messages = [`Профиль «${profile.name}» добавлен.`];
          if(generatorApplyFonts?.checked){
            const applied = applyFontPayload(result.fonts);
            if(applied){
              messages.push(`Шрифты: ${result.profile.fonts.heading} / ${result.profile.fonts.main}`);
            }
          }
          generatorStatus.textContent = messages.join(' ');
          showStatus(`Профиль «${profile.name}» создан генератором.`);
          showNotice('Создан новый профиль из генератора.');
        }catch(error){
          generatorStatus.textContent = error.message || 'Не удалось создать профиль.';
        }
      });
    }

    function setAliasConfig(variable, config){
      activeProfile.aliases[variable] = config;
      applyPalette(activeProfile);
      saveState();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();
      showStatus('Alias обновлён');
    }

    function afterBaseUpdate(){
      applyPalette(activeProfile);
      saveState();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();
      showStatus('Цвет сохранён');
    }

    function renderPreview(){
      previewProfile.textContent = activeProfile.name;
      updateRatioPreview();
      updateContrast();
    }

    function renderPresetCatalog(){
      if(!presetGrid) return;
      presetGrid.innerHTML='';
      const normalizedActive = activeProfile ? normalizeProfile(activeProfile) : null;
      const activeResolved = normalizedActive ? resolveAliases(normalizedActive) : null;

      standardPresets.forEach(preset=>{
        const card = document.createElement('article');
        card.className = 'preset-card';

        const title = document.createElement('div');
        title.className = 'preset-title';
        title.textContent = preset.name;
        card.appendChild(title);

        const resolvedPreset = resolveAliases(preset.profile);
        const swatches = document.createElement('div');
        swatches.className = 'preset-swatches';
        [
          preset.profile.base['--color-base'],
          preset.profile.base['--color-secondary'],
          preset.profile.base['--color-accent'],
          resolvedPreset['--action-primary']
        ].forEach(color=>{
          const swatch = document.createElement('span');
          swatch.className = 'preset-swatch';
          swatch.style.background = color;
          swatch.title = color;
          swatch.style.color = getReadableTextColor(color);
          swatches.appendChild(swatch);
        });
        card.appendChild(swatches);

        if(preset.tags && preset.tags.length){
          const tagsWrap = document.createElement('div');
          tagsWrap.className = 'preset-tags';
          preset.tags.forEach(tag=>{
            const tagNode = document.createElement('span');
            tagNode.textContent = tag;
            tagsWrap.appendChild(tagNode);
          });
          card.appendChild(tagsWrap);
        }

        if(preset.description){
          const desc = document.createElement('p');
          desc.className = 'preset-desc';
          desc.textContent = preset.description;
          card.appendChild(desc);
        }

        const action = document.createElement('button');
        action.type = 'button';
        action.className = 'btn preset-apply';
        action.textContent = 'Добавить в профили';
        action.addEventListener('click', ()=>{
          const instance = cloneProfile(preset.profile);
          instance.id = generateUniqueId(`std-${preset.id}`);
          instance.name = preset.name;
          state.profiles.push(instance);
          setActiveProfile(instance.id);
          initProfileSelect();
          showStatus(`Профиль «${preset.name}» добавлен из каталога.`);
          showNotice(`Активирован «${preset.name}».`);
        });
        card.appendChild(action);

        const isActive = normalizedActive
          && BASE_TOKENS.every(token=>normalizedActive.base[token.variable] === preset.profile.base[token.variable])
          && aliasKeys.every(key=>{
            const activeValue = activeResolved ? activeResolved[key] : '';
            const presetValue = resolvedPreset[key] || '';
            return activeValue === presetValue;
          });

        if(isActive){
          card.classList.add('is-active');
          action.textContent = 'Активен';
          action.disabled = true;
        }

        presetGrid.appendChild(card);
      });
    }

    function updateRatioPreview(){
      if(!ratioSegments.length) return;
      const resolved = resolveAliases(activeProfile);
      const mapping = {
        primary: resolved['--surface-primary'] || activeProfile.base['--color-base'],
        secondary: resolved['--surface-muted'] || activeProfile.base['--color-secondary'],
        accent: resolved['--action-primary'] || mixColors(activeProfile.base['--color-accent'], activeProfile.base['--color-neutral'], 0.18)
      };
      const flexMap = {primary:6, secondary:3, accent:1};
      ratioSegments.forEach(segment=>{
        const key = segment.dataset.ratio;
        const color = mapping[key] || activeProfile.base['--color-base'] || '#CCCCCC';
        const weight = flexMap[key] || 1;
        segment.style.flex = `${weight} ${weight} 0`;
        segment.style.background = color;
        segment.style.color = getReadableTextColor(color);
        const percent = key==='primary' ? 60 : key==='secondary' ? 30 : 10;
        segment.textContent = `${percent}%`;
      });
      ratioDots.forEach(dot=>{
        const key = dot.dataset.ratioDot;
        const color = mapping[key] || activeProfile.base['--color-base'] || '#CCCCCC';
        dot.style.background = color;
        dot.style.borderColor = getReadableTextColor(color);
      });
    }

    function updateContrast(){
      const resolved = resolveAliases(activeProfile);
      const pairs = [
        {label:'Текст / фон', fg:resolved['--text-strong'], bg:resolved['--surface-primary'], kind:'normal', sample:'Aa'},
        {label:'Вторичный текст / фон', fg:resolved['--text-muted'], bg:resolved['--surface-primary'], kind:'normal', sample:'Aa'},
        {label:'Кнопка / текст', fg:'#FFFFFF', bg:resolved['--action-primary'], kind:'large', sample:'BTN'},
        {label:'Кнопка (hover) / текст', fg:'#FFFFFF', bg:resolved['--action-primary-hover'], kind:'large', sample:'BTN'}
      ];
      contrastList.innerHTML='';
      pairs.forEach(pair=>{
        const ratio = calculateContrast(pair.fg, pair.bg);
        const verdict = describeContrast(ratio, pair.kind);
        const item = document.createElement('div');
        item.className = `contrast-item ${verdict.status}`;

        const combo = document.createElement('div');
        combo.className = 'combo';
        const label = document.createElement('span');
        label.textContent = pair.label;
        const swatch = document.createElement('span');
        swatch.className = 'swatch';
        swatch.style.background = pair.bg;
        swatch.style.color = pair.fg;
        swatch.textContent = pair.sample || 'Aa';
        combo.append(label, swatch);

        const meta = document.createElement('div');
        meta.style.display='flex';
        meta.style.alignItems='center';
        meta.style.justifyContent='space-between';
        const ratioSpan = document.createElement('span');
        ratioSpan.className='ratio';
        ratioSpan.textContent = ratio.toFixed(2);
        const badge = document.createElement('span');
        badge.className='badge';
        badge.textContent = verdict.badge;
        meta.append(ratioSpan, badge);

        const guide = document.createElement('span');
        guide.className = 'guide';
        guide.textContent = verdict.helper;

        item.append(combo, meta, guide);
        contrastList.appendChild(item);
      });
    }

    function describeContrast(ratio, kind){
      const thresholds = kind === 'large'
        ? {AA:3, AAA:4.5, label:'крупного текста'}
        : {AA:4.5, AAA:7, label:'обычного текста'};
      if(ratio >= thresholds.AAA){
        return {status:'pass', badge:'AAA', helper:`Отлично: превышает уровень AAA для ${thresholds.label}.`};
      }
      if(ratio >= thresholds.AA){
        return {status:'pass', badge:'AA', helper:`Достаточно: соответствует уровню AA для ${thresholds.label}.`};
      }
      const warnFloor = Math.max(0, thresholds.AA - 0.5);
      if(ratio >= warnFloor){
        return {status:'warn', badge:'Почти', helper:`Почти достаточно — усилите контраст до ${thresholds.AA.toFixed(1)}.`};
      }
      return {status:'fail', badge:'Ниже нормы', helper:`Недостаточно: цель ≥ ${thresholds.AA.toFixed(1)} для ${thresholds.label}.`};
    }

    function setActiveProfile(id){
      const profile = state.profiles.find(p=>p.id===id);
      if(!profile) return;
      activeProfile = profile;
      state.activeId = profile.id;
      applyPalette(activeProfile);
      saveState();
      buildBaseControls();
      renderAliasControls();
      renderPreview();
      renderPresetCatalog();
    }

    function saveState(){
      state = persistState(state);
    }

    function buildProfileFromGenerated(result, name){
      const base = {...result.tokens};
      const aliases = {...result.aliases};
      const profile = {
        id: generateUniqueId(slugify(name || 'palette')), 
        name: name || 'Новая палитра',
        base,
        aliases
      };
      return normalizeProfile(profile);
    }

    function buildGeneratorName(result, hex){
      const suffix = hex ? hex.replace('#','').toUpperCase() : randomId().slice(-4);
      const prefix = result?.meta?.strategy === '60-30-10' ? 'Палитра 60·30·10' : 'Палитра';
      return `${prefix} ${suffix}`;
    }

    function buildCssSnippet(profile){
      const aliases = resolveAliases(profile);
      const lines = [
        ...Object.entries(profile.base),
        ...Object.entries(aliases)
      ].map(([key,value])=>`  ${key}: ${value};`);
      return `:root\n{\n${lines.join('\n')}\n}`;
    }

    function buildExportPayload(){
      const payload = {
        activeId: state.activeId,
        profiles: serializeProfiles()
      };
      const fontsPayload = getFontExportPayload();
      if(fontsPayload) payload.fonts = fontsPayload;
      return payload;
    }

    function serializeProfiles(){
      return state.profiles.map(profile=>cloneProfile(profile));
    }

    function getFontExportPayload(){
      const stored = readStoredFontPayload();
      if(stored) return stored;
      return sanitizeFontPayload(fonts);
    }

    function readStoredFontPayload(){
      try{
        const raw = localStorage.getItem(FONT_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === 'object'){
          return sanitizeFontPayload(parsed);
        }
      }catch(e){
        return null;
      }
      return null;
    }

    function applyFontPayload(payload){
      if(!payload || typeof payload !== 'object') return false;
      try{
        const sanitized = sanitizeFontPayload(payload);
        localStorage.setItem(FONT_KEY, JSON.stringify(sanitized));
        fonts = loadFonts();
        applyFonts(fonts);
        return true;
      }catch(e){
        return false;
      }
    }

    function sanitizeFontPayload(source){
      const roles = ['heading','text','ui'];
      const sanitized = {};
      roles.forEach(role=>{
        const fallback = DEFAULT_FONT_META[role] || {};
        const entry = source && typeof source === 'object' ? source[role] : null;
        const meta = {...fallback};
        if(entry && typeof entry === 'object'){
          if(entry.id) meta.id = entry.id;
          if(entry.family) meta.family = entry.family;
          if(entry.stack) meta.stack = entry.stack;
          if(entry.css) meta.css = entry.css;
          if(entry.category) meta.category = entry.category;
          if(Array.isArray(entry.weights)) meta.weights = entry.weights;
          if(Array.isArray(entry.tags)) meta.tags = entry.tags;
        }
        if(!meta.family) meta.family = fallback.family || role;
        if(!meta.stack) meta.stack = fallback.stack || `'${meta.family}', sans-serif`;
        sanitized[role] = {
          id: meta.id || slugify(meta.family || role),
          family: meta.family,
          stack: meta.stack,
          css: meta.css || fallback.css || ''
        };
        if(meta.category) sanitized[role].category = meta.category;
        if(meta.weights) sanitized[role].weights = meta.weights;
        if(meta.tags) sanitized[role].tags = meta.tags;
      });
      return sanitized;
    }

    function showStatus(message){
      statusMessage.textContent = message;
    }

    function showNotice(text){
      notice.textContent = text;
      notice.classList.add('show');
      clearTimeout(showNotice.timer);
      showNotice.timer = setTimeout(()=>notice.classList.remove('show'),1400);
    }

    function computeMutedTextColor(baseTokens, aliasTokens){
      const baseText = normalizeHex(baseTokens['--color-neutral']) || '#000000';
      const background = normalizeHex(aliasTokens['--surface-primary'] || baseTokens['--color-base']) || '#FFFFFF';
      // Оттеняем основной цвет за счёт фона — без искусственного повышения контраста,
      // чтобы диагностика оставалась честной и совпадала с реальными HEX-значениями профиля.
      return mixColors(baseText, background, 0.42);
    }

    function parseHex(hex){
      const normalized = normalizeHex(hex) || '#000000';
      return {
        r:parseInt(normalized.slice(1,3),16),
        g:parseInt(normalized.slice(3,5),16),
        b:parseInt(normalized.slice(5,7),16)
      };
    }

    function rgbToHex({r,g,b}){
      return '#'+[r,g,b].map(v=>{
        const h=v.toString(16).toUpperCase();
        return h.length===1?'0'+h:h;
      }).join('');
    }

    function generateUniqueId(preferred){
      const cleaned = preferred && typeof preferred === 'string'
        ? preferred.trim().replace(/[^a-zA-Z0-9_-]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'')
        : '';
      const base = cleaned ? cleaned.toLowerCase() : randomId();
      let candidate = base || randomId();
      while(state.profiles.some(profile=>profile.id===candidate)){
        candidate = `${base}-${Math.random().toString(36).slice(2,6)}`;
      }
      return candidate;
    }

    function formatImportName(name){
      const base = name && String(name).trim() ? String(name).trim() : 'Импортированный профиль';
      if(base.toLowerCase().includes('импорт')) return base;
      return `${base} (импорт)`;
    }

    function calculateContrast(fg, bg){
      const l1 = relativeLuminance(parseHex(fg));
      const l2 = relativeLuminance(parseHex(bg));
      const brightest = Math.max(l1, l2);
      const darkest = Math.min(l1, l2);
      return (brightest + 0.05) / (darkest + 0.05);
    }

    function getReadableTextColor(hex){
      const luminance = relativeLuminance(parseHex(hex));
      return luminance > 0.6 ? '#1F1D2A' : '#FFFFFF';
    }

    function relativeLuminance({r,g,b}){
      const srgb = [r,g,b].map(v=>{
        const c = v/255;
        return c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055,2.4);
      });
      return srgb[0]*0.2126 + srgb[1]*0.7152 + srgb[2]*0.0722;
    }

    function loadFonts(){
      try{
        const raw = localStorage.getItem(FONT_KEY);
        if(!raw) return cloneFontMeta(DEFAULT_FONT_META);
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed.heading === 'object' && parsed.heading !== null && parsed.heading.stack){
          return {
            heading: normalizeFontMeta(parsed.heading, DEFAULT_FONT_META.heading),
            text: normalizeFontMeta(parsed.text, DEFAULT_FONT_META.text),
            ui: normalizeFontMeta(parsed.ui, DEFAULT_FONT_META.ui)
          };
        }
        return {
          heading: legacyFontMeta(parsed?.heading, DEFAULT_FONT_META.heading),
          text: legacyFontMeta(parsed?.text, DEFAULT_FONT_META.text),
          ui: legacyFontMeta(parsed?.ui, DEFAULT_FONT_META.ui)
        };
      }catch(e){
        return cloneFontMeta(DEFAULT_FONT_META);
      }
    }

    function applyFonts(fonts){
      const root = document.documentElement;
      ['heading','text','ui'].forEach(key=>{
        const meta = fonts[key] || DEFAULT_FONT_META[key];
        if(meta?.css) ensureFontLoaded(meta);
        root.style.setProperty(key==='heading'?'--font-heading':key==='text'?'--font-body':'--font-ui', meta?.stack || DEFAULT_FONT_META[key].stack);
      });
    }

    function ensureFontLoaded(font){
      if(!font?.css) return;
      const id = 'font-'+(font.id || slugify(font.family || 'font'));
      if(document.getElementById(id)) return;
      const link = document.createElement('link');
      link.id = id;
      link.rel = 'stylesheet';
      link.href = font.css;
      document.head.appendChild(link);
    }

    function cloneFontMeta(source){
      return {
        heading: source.heading ? {...source.heading} : null,
        text: source.text ? {...source.text} : null,
        ui: source.ui ? {...source.ui} : null
      };
    }

    function normalizeFontMeta(entry, fallback){
      const base = fallback ? {...fallback} : {family:'Inter', stack:"'Inter', sans-serif", css:'', id:'inter'};
      if(entry && typeof entry === 'object'){
        if(entry.id) base.id = entry.id;
        if(entry.family) base.family = entry.family;
        if(entry.stack) base.stack = entry.stack;
        if(entry.css) base.css = entry.css;
      }
      return base;
    }

    function legacyFontMeta(id, fallback){
      if(id && LEGACY_FONT_MAP[id]){
        return {...LEGACY_FONT_MAP[id]};
      }
      return {...fallback};
    }

    function slugify(value){
      return String(value).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }
  </script>
</body>
</html>
