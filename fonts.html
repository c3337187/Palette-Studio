<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Настройка шрифтов</title>
  <style>
    :root{
      --color-base:#F5F3FA;
      --color-secondary:#D6CFFE;
      --color-accent:#FFB870;
      --color-neutral:#2F2537;
      --surface-primary:var(--color-base);
      --surface-card:color-mix(in srgb,var(--color-base) 85%, white 15%);
      --surface-muted:color-mix(in srgb,var(--color-secondary) 35%, white);
      --surface-hero:color-mix(in srgb,var(--color-secondary) 60%, var(--color-accent));
      --surface-accent:color-mix(in srgb,var(--color-secondary) 70%, var(--color-neutral));
      --text-strong:var(--color-neutral);
      --text-muted:color-mix(in srgb,var(--color-neutral) 58%, var(--surface-primary) 42%);
      --border-subtle:color-mix(in srgb,var(--color-secondary) 24%, var(--color-neutral));
      --action-primary:color-mix(in srgb,var(--color-accent) 82%, var(--color-neutral));
      --action-primary-hover:color-mix(in srgb,var(--color-accent) 92%, white 8%);
      --badge-accent:color-mix(in srgb,var(--color-secondary) 55%, white);
      --ratio-primary:var(--surface-primary);
      --ratio-secondary:var(--surface-muted);
      --ratio-accent:var(--action-primary);
      --font-heading:'Manrope', 'Inter', 'Segoe UI', system-ui, sans-serif;
      --font-body:'Inter', 'Segoe UI', system-ui, sans-serif;
      --font-ui:'Manrope', 'Inter', 'Segoe UI', system-ui, sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--surface-primary),#fff 70%);color:var(--text-strong);font-family:var(--font-body);line-height:1.6;min-height:100vh;overflow-x:hidden}
    a{text-decoration:none;color:inherit}
    .topbar{background:rgba(255,255,255,0.85);backdrop-filter:blur(14px);border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:0;z-index:10}
    .topbar .container{max-width:1200px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;gap:20px}
    .brand{font-weight:700;font-size:18px;letter-spacing:0.06em;text-transform:uppercase;color:color-mix(in srgb,var(--color-neutral) 85%, white 15%)}
    .nav-links{display:flex;gap:12px;font-size:14px}
    .nav-link{padding:8px 14px;border-radius:999px;color:var(--text-muted);transition:background .2s,color .2s}
    .nav-link:hover{background:var(--surface-muted);color:var(--text-strong)}
    .nav-link.active{background:var(--action-primary);color:#fff;box-shadow:0 10px 24px rgba(76,45,110,0.2)}
    .wrapper{max-width:1200px;margin:0 auto;padding:40px 24px 72px;display:flex;flex-direction:column;gap:40px}
    .intro{background:var(--surface-card);padding:28px;border-radius:22px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 18px 48px rgba(54,38,70,0.14);display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;align-items:center}
    .intro h1{margin:0;font-size:30px;font-family:var(--font-heading)}
    .intro p{margin:12px 0 0;color:var(--text-muted)}
    .intro-actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{padding:10px 18px;border-radius:14px;border:1px solid var(--border-subtle);background:var(--surface-card);color:var(--text-strong);font-size:14px;font-family:var(--font-ui);font-weight:600;cursor:pointer;transition:background .2s,box-shadow .2s}
    .btn:hover{background:var(--surface-muted)}
    .btn-primary{background:var(--action-primary);color:#fff;box-shadow:0 12px 30px rgba(76,45,110,0.22);border:none}
    .btn-primary:hover{background:var(--action-primary-hover)}
    .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
    .control-card{background:var(--surface-card);border-radius:18px;padding:20px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 12px 34px rgba(54,38,70,0.1);display:flex;flex-direction:column;gap:14px}
    .control-card h2{margin:0;font-size:18px;font-family:var(--font-heading)}
    .control-card label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:color-mix(in srgb,var(--color-neutral) 85%, white 15%)}
    .control-card select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.12);font-size:14px;background:#fff;color:var(--text-strong)}
    .font-meta{font-size:13px;color:var(--text-muted)}
    .sample-block{background:var(--surface-muted);border-radius:14px;padding:16px;border:1px solid rgba(0,0,0,0.05);display:flex;flex-direction:column;gap:10px}
    .pairings{background:var(--surface-card);border-radius:22px;padding:28px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 16px 40px rgba(54,38,70,0.12);display:flex;flex-direction:column;gap:20px}
    .pairings-header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .pairings-header h2{margin:0;font-size:22px;font-family:var(--font-heading)}
    .pairings-hint{margin:0;color:var(--text-muted);font-size:14px;max-width:720px}
    .pairing-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .pairing-card{background:var(--surface-muted);border:1px solid rgba(0,0,0,0.06);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px}
    .pairing-card h3{margin:0;font-size:16px;font-family:var(--font-heading)}
    .pairing-card p{margin:0;font-size:13px;color:var(--text-muted)}
    .pairing-roles{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--text-muted)}
    .pairing-roles .pairing-role{display:flex;justify-content:space-between;gap:12px;color:var(--text-strong)}
    .pairing-roles .pairing-role strong{font-weight:600}
    .pairing-roles .pairing-role span{color:var(--text-muted);font-weight:500}
    .pairing-card button{align-self:flex-start}
    .status{font-size:12px;color:var(--text-muted)}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:24px}
    .preview-card{background:var(--surface-card);border-radius:18px;padding:24px;border:1px solid rgba(54,38,70,0.08);box-shadow:0 14px 38px rgba(54,38,70,0.1);display:flex;flex-direction:column;gap:16px}
    .preview-card h3{margin:0;font-size:18px;font-family:var(--font-heading)}
    .type-row{display:flex;flex-direction:column;gap:6px}
    .type-row span{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em}
    .preview-paragraph{font-size:16px;line-height:1.7;font-family:var(--font-body)}
    .preview-button{padding:12px 20px;border-radius:14px;border:none;background:var(--action-primary);color:#fff;font-family:var(--font-ui);font-weight:600;display:inline-flex;align-items:center;gap:8px}
    .preview-button:hover{background:var(--action-primary-hover)}
    .catalog{position:fixed;inset:0;background:rgba(28,20,36,0.55);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;padding:24px;transition:opacity .3s,visibility .3s}
    .catalog[aria-hidden="true"]{opacity:0;visibility:hidden;pointer-events:none}
    .catalog-dialog{background:var(--surface-card);max-width:900px;width:100%;max-height:90vh;overflow:hidden;border-radius:20px;border:1px solid rgba(0,0,0,0.08);box-shadow:0 24px 65px rgba(28,20,36,0.35);display:flex;flex-direction:column;gap:0}
    .catalog-header{padding:20px 24px;display:flex;justify-content:space-between;align-items:flex-start;gap:20px;border-bottom:1px solid rgba(0,0,0,0.06)}
    .catalog-header h2{margin:0;font-size:22px;font-family:var(--font-heading)}
    .catalog-header p{margin:6px 0 0;color:var(--text-muted);font-size:13px;max-width:440px}
    .catalog-controls{padding:16px 24px;display:flex;gap:12px;border-bottom:1px solid rgba(0,0,0,0.06);flex-wrap:wrap}
    .catalog-controls input[type="search"]{flex:1 1 240px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.12);font-size:14px}
    .catalog-controls select{flex:0 0 200px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.12);font-size:14px;background:#fff;color:var(--text-strong)}
    .catalog-results{padding:20px 24px;overflow:auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .catalog-item{border:1px solid rgba(0,0,0,0.06);border-radius:16px;padding:16px;background:var(--surface-muted);display:flex;flex-direction:column;gap:10px}
    .catalog-item h3{margin:0;font-size:16px;font-family:var(--font-heading)}
    .catalog-item .category{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
    .catalog-preview{font-size:18px;line-height:1.4}
    .catalog-tags{display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:var(--text-muted)}
    .catalog-tags span{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,0.05)}
    .catalog-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .catalog-actions .btn{padding:6px 10px;font-size:12px;border-radius:10px}
    .catalog-empty{grid-column:1/-1;padding:40px;border-radius:16px;text-align:center;background:var(--surface-muted);border:1px solid rgba(0,0,0,0.06);font-size:14px;color:var(--text-muted)}
    .notice{position:fixed;right:24px;bottom:24px;padding:12px 16px;border-radius:12px;background:var(--text-strong);color:#fff;font-size:13px;opacity:0;transform:translateY(12px);transition:all .3s}
    .notice.show{opacity:1;transform:translateY(0)}
    @media(max-width:720px){
      .wrapper{padding:32px 16px 56px}
      .intro{grid-template-columns:1fr}
      .pairings{padding:20px}
      .catalog-dialog{max-height:85vh}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="brand">Palette Studio</div>
      <nav class="nav-links">
        <a class="nav-link" href="index.html">Палитра</a>
        <a class="nav-link" href="lab.html">Лаборатория</a>
        <a class="nav-link active" href="fonts.html">Шрифты</a>
      </nav>
    </div>
  </header>

  <main class="wrapper">
    <section class="intro">
      <div>
        <h1>Настройка шрифтов</h1>
        <p>Выберите гарнитуры для заголовков, основного текста и UI-элементов. Изменения сохраняются и моментально применяются к стенду и лаборатории.</p>
      </div>
      <div class="intro-actions">
        <button class="btn" id="openCatalog">Каталог шрифтов</button>
        <button class="btn" id="scrollPairings">Актуальные вариации</button>
        <button class="btn" id="resetFonts">Сбросить к умолчанию</button>
        <a class="btn-primary btn" href="https://fonts.google.com/?subset=cyrillic" target="_blank" rel="noopener">Открыть Google Fonts</a>
      </div>
    </section>

    <section class="controls-grid">
      <div class="control-card">
        <h2>Заголовки</h2>
        <label for="headingSelect">Шрифт</label>
        <select id="headingSelect"></select>
        <div class="sample-block" style="font-family:var(--font-heading)">
          <div style="font-size:32px;font-weight:700">Заголовок H1</div>
          <div style="font-size:26px;font-weight:600">Заголовок H2</div>
          <div style="font-size:20px;font-weight:600">Заголовок H3</div>
        </div>
        <div class="font-meta" id="headingMeta"></div>
      </div>
      <div class="control-card">
        <h2>Основной текст</h2>
        <label for="bodySelect">Шрифт</label>
        <select id="bodySelect"></select>
        <div class="sample-block" style="font-family:var(--font-body)">
          <p style="margin:0">Абзацы, подсказки, статьи — шрифт должен быть удобочитаемым и поддерживать кириллицу.</p>
        </div>
        <div class="font-meta" id="bodyMeta"></div>
      </div>
      <div class="control-card">
        <h2>UI элементы</h2>
        <label for="uiSelect">Шрифт</label>
        <select id="uiSelect"></select>
        <div class="sample-block" style="font-family:var(--font-ui)">
          <button class="preview-button" type="button">Кнопка действия</button>
          <div style="font-size:14px;text-transform:uppercase;letter-spacing:0.08em">Навигация / label</div>
        </div>
        <div class="font-meta" id="uiMeta"></div>
      </div>
    </section>

    <section class="pairings" id="pairingsSection">
      <div class="pairings-header">
        <h2>Популярные сочетания</h2>
        <button class="btn" id="randomPairing">Случайная пара</button>
      </div>
      <p class="pairings-hint">Готовые связки шрифтов для заголовков, основного текста и интерфейсных элементов. Один клик — и набор применён ко всем страницам.</p>
      <div class="pairing-grid" id="pairingList"></div>
    </section>

    <section class="preview-grid">
      <div class="preview-card">
        <h3>Заголовки</h3>
        <div class="type-row" style="font-family:var(--font-heading)">
          <span>H1</span>
          <div style="font-size:36px;font-weight:700">Палитра и типографика</div>
        </div>
        <div class="type-row" style="font-family:var(--font-heading)">
          <span>H2</span>
          <div style="font-size:28px;font-weight:600">Интерфейсные компоненты</div>
        </div>
        <div class="type-row" style="font-family:var(--font-heading)">
          <span>H3</span>
          <div style="font-size:22px;font-weight:600">Подзаголовок блока</div>
        </div>
        <div class="type-row" style="font-family:var(--font-heading)">
          <span>H4–H6</span>
          <div style="font-size:18px;font-weight:500">Гибкая настройка палитры</div>
        </div>
      </div>
      <div class="preview-card">
        <h3>Текст и параграфы</h3>
        <p class="preview-paragraph">Эта страница помогает подобрать подходящие шрифтовые пары для проекта. Сохраняйте настройки и возвращайтесь к ним на стенде. Все гарнитуры поддерживают кириллицу и доступны через Google Fonts.</p>
        <p class="preview-paragraph" style="color:var(--text-muted)">Поддерживаются три роли: заголовки, основной текст и элементы интерфейса. Каждая роль может использовать отдельную гарнитуру.</p>
      </div>
      <div class="preview-card">
        <h3>UI пример</h3>
        <nav style="display:flex;justify-content:space-between;align-items:center;background:var(--surface-muted);padding:12px 16px;border-radius:14px;border:1px solid var(--border-subtle);font-family:var(--font-ui)">
          <div style="font-weight:700">Логотип</div>
          <div style="display:flex;gap:12px;font-size:14px;color:var(--text-muted)">
            <span>Главная</span>
            <span>Команда</span>
            <span>Контакты</span>
          </div>
        </nav>
        <form style="display:flex;flex-direction:column;gap:12px;font-family:var(--font-body)">
          <label style="font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted)">Email</label>
          <input type="email" placeholder="you@example.com" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border-subtle);background:var(--surface-card);color:var(--text-strong)" />
          <button class="preview-button" type="button" style="align-self:flex-start">Подписаться</button>
        </form>
      </div>
    </section>

    <div class="status" id="statusMessage">Выберите шрифты, чтобы обновить профиль.</div>
  </main>

  <div class="catalog" id="catalogModal" aria-hidden="true">
    <div class="catalog-dialog" role="dialog" aria-modal="true" aria-labelledby="catalogTitle">
      <header class="catalog-header">
        <div>
          <h2 id="catalogTitle">Каталог шрифтов</h2>
          <p>Поиск по Google Fonts с поддержкой кириллицы. Выберите роль, чтобы применить гарнитуру.</p>
        </div>
        <button class="btn" type="button" id="catalogClose">Закрыть</button>
      </header>
      <div class="catalog-controls">
        <input type="search" id="catalogSearch" placeholder="Введите название шрифта" />
        <select id="catalogCategory">
          <option value="all">Все категории</option>
          <option value="sans-serif">Гротеск</option>
          <option value="serif">Антиква</option>
          <option value="slab">Слаб-сериф</option>
          <option value="display">Дисплейный</option>
          <option value="handwriting">Рукописный</option>
          <option value="monospace">Моно</option>
        </select>
      </div>
      <div class="catalog-results" id="catalogList"></div>
    </div>
  </div>

  <div class="notice" id="notice"></div>

  <script>
    const STORAGE_KEY = 'palette-studio-profiles';
    const FONT_KEY = 'palette-studio-fonts';

    const BASE_TOKENS = [
      {variable:'--color-base', default:'#F5F3FA'},
      {variable:'--color-secondary', default:'#D6CFFE'},
      {variable:'--color-accent', default:'#FFB870'},
      {variable:'--color-neutral', default:'#2F2537'}
    ];

    const ALIAS_DEFS = [
      {variable:'--surface-primary', defaultConfig:()=>({mode:'base', ref:'--color-base'})},
      {variable:'--surface-card', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-base'], '#FFFFFF', 0.15)},
      {variable:'--surface-muted', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-secondary'], '#FFFFFF', 0.65)},
      {variable:'--surface-hero', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-secondary'], base['--color-accent'], 0.4)},
      {variable:'--surface-accent', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-secondary'], base['--color-neutral'], 0.3)},
      {variable:'--text-strong', defaultConfig:()=>({mode:'base', ref:'--color-neutral'})},
      {variable:'--text-muted', defaultConfig:()=>({mode:'auto'}), auto:(base, alias)=>mixColors(base['--color-neutral'], alias['--surface-primary'] || base['--color-base'], 0.42)},
      {variable:'--border-subtle', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-secondary'], base['--color-neutral'], 0.12)},
      {variable:'--action-primary', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-accent'], base['--color-neutral'], 0.18)},
      {variable:'--action-primary-hover', defaultConfig:()=>({mode:'auto'}), auto:(base, alias)=>mixColors(alias['--action-primary'] || mixColors(base['--color-accent'], base['--color-neutral'], 0.18), '#FFFFFF', 0.08)},
      {variable:'--badge-accent', defaultConfig:()=>({mode:'auto'}), auto:(base)=>mixColors(base['--color-secondary'], '#FFFFFF', 0.45)}
    ];
    const DEFAULT_PROFILES = [
      {
        id:'balanced-mauve',
        name:'Нейтральный баланс',
        base:Object.fromEntries(BASE_TOKENS.map(t=>[t.variable,t.default])),
        aliases:{},
      },
      {
        id:'twilight-gold',
        name:'Сумеречный контраст',
        base:{
          '--color-base':'#1C1B23',
          '--color-secondary':'#2D2535',
          '--color-accent':'#E7A04E',
          '--color-neutral':'#F4F1FF'
        },
        aliases:{},
      }
    ];
    const DEFAULT_STATE = {activeId:'balanced-mauve', profiles:DEFAULT_PROFILES};

    const RAW_FONTS = [
      {family:'Inter', category:'sans-serif', weights:[300,400,500,600,700], popularity:1, tags:['универсальный','ui']},
      {family:'Manrope', category:'sans-serif', weights:[400,500,600,700,800], popularity:2, tags:['заголовки','ui']},
      {family:'Roboto', category:'sans-serif', weights:[300,400,500,700], popularity:3, tags:['google','универсальный']},
      {family:'Open Sans', category:'sans-serif', weights:[300,400,600,700], popularity:4, tags:['ui','текст']},
      {family:'Montserrat', category:'sans-serif', weights:[400,500,600,700], popularity:5, tags:['контраст','заголовки']},
      {family:'Raleway', category:'sans-serif', weights:[400,500,600,700], popularity:6, tags:['легкий','заголовки']},
      {family:'Nunito', category:'sans-serif', weights:[300,400,600,700], popularity:7, tags:['дружелюбный','текст']},
      {family:'Nunito Sans', category:'sans-serif', weights:[300,400,600,700], popularity:8, tags:['ui','дружелюбный']},
      {family:'Rubik', category:'sans-serif', weights:[400,500,600,700], popularity:9, tags:['rounded','ui']},
      {family:'Golos Text', category:'sans-serif', weights:[400,500,600,700], popularity:10, tags:['корпоративный','ru']},
      {family:'Golos UI', category:'sans-serif', weights:[400,500,600], popularity:11, tags:['ru','интерфейс']},
      {family:'Noto Sans', category:'sans-serif', weights:[400,500,600,700], popularity:12, tags:['универсальный']},
      {family:'Noto Serif', category:'serif', weights:[400,600,700], popularity:13, tags:['редакция','антиква']},
      {family:'PT Sans', category:'sans-serif', weights:[400,700], popularity:14, tags:['ru','классика']},
      {family:'PT Serif', category:'serif', weights:[400,700], popularity:15, tags:['ru','антиква']},
      {family:'Playfair Display', category:'serif', weights:[400,600,700], popularity:16, tags:['контраст','редакция']},
      {family:'Lora', category:'serif', weights:[400,500,600,700], popularity:17, tags:['редакция','текст']},
      {family:'Merriweather', category:'serif', weights:[400,700], popularity:18, tags:['читабельный','антиква']},
      {family:'Cormorant Garamond', category:'serif', weights:[400,500,600,700], popularity:19, tags:['премиум','дисплей']},
      {family:'Spectral', category:'serif', weights:[400,500,600,700], popularity:20, tags:['лонгрид','антиква']},
      {family:'Source Sans 3', category:'sans-serif', weights:[300,400,600,700], popularity:21, tags:['редакция','универсальный']},
      {family:'Source Serif 4', category:'serif', weights:[400,600,700], popularity:22, tags:['редакция','антиква']},
      {family:'IBM Plex Sans', category:'sans-serif', weights:[400,500,600,700], popularity:23, tags:['tech','ui']},
      {family:'IBM Plex Serif', category:'serif', weights:[400,500,600,700], popularity:24, tags:['tech','антиква']},
      {family:'Mulish', category:'sans-serif', weights:[300,400,600,700], popularity:25, tags:['легкий','ui']},
      {family:'Ubuntu', category:'sans-serif', weights:[300,400,500,700], popularity:26, tags:['теплый','ui']},
      {family:'Exo 2', category:'sans-serif', weights:[400,500,600,700], popularity:27, tags:['техно','ui']},
      {family:'Fira Sans', category:'sans-serif', weights:[300,400,500,700], popularity:28, tags:['универсальный','ui']},
      {family:'Fira Sans Condensed', category:'sans-serif', weights:[300,400,500,700], popularity:29, tags:['узкий','ui']},
      {family:'Oswald', category:'sans-serif', weights:[400,500,600,700], popularity:30, tags:['узкий','headline']},
      {family:'Yanone Kaffeesatz', category:'sans-serif', weights:[400,500,600,700], popularity:31, tags:['headline','узкий']},
      {family:'Comfortaa', category:'display', weights:[300,400,700], popularity:32, tags:['rounded','friendly']},
      {family:'Caveat', category:'handwriting', weights:[400,500,600,700], popularity:33, tags:['handwriting','подпись']},
      {family:'Neucha', category:'handwriting', weights:[400], popularity:34, tags:['рукописный']},
      {family:'Marck Script', category:'handwriting', weights:[400], popularity:35, tags:['подпись']},
      {family:'Russo One', category:'display', weights:[400], popularity:36, tags:['headline','жирный']},
      {family:'Philosopher', category:'serif', weights:[400,700], popularity:37, tags:['легкий','антиква']},
      {family:'Oranienbaum', category:'serif', weights:[400], popularity:38, tags:['классика','антиква']},
      {family:'Forum', category:'serif', weights:[400], popularity:39, tags:['дисплей','антиква']},
      {family:'Alice', category:'serif', weights:[400], popularity:40, tags:['новости','антиква']},
      {family:'Tinos', category:'serif', weights:[400,700], popularity:41, tags:['читабельный']},
      {family:'Arimo', category:'sans-serif', weights:[400,700], popularity:42, tags:['универсальный']},
      {family:'Jost', category:'sans-serif', weights:[300,400,500,700], popularity:43, tags:['геометрия','headline']},
      {family:'Jura', category:'sans-serif', weights:[300,400,500,700], popularity:44, tags:['техно','узкий']},
      {family:'Istok Web', category:'sans-serif', weights:[400,700], popularity:45, tags:['корпоративный']},
      {family:'Tenor Sans', category:'sans-serif', weights:[400], popularity:46, tags:['новости']},
      {family:'Scada', category:'sans-serif', weights:[400,700], popularity:47, tags:['деловой']},
      {family:'Cuprum', category:'sans-serif', weights:[400,700], popularity:48, tags:['узкий']},
      {family:'Didact Gothic', category:'sans-serif', weights:[400], popularity:49, tags:['дружелюбный']},
      {family:'JetBrains Mono', category:'monospace', weights:[400,500,600,700], popularity:50, tags:['код','tech']},
      {family:'PT Mono', category:'monospace', weights:[400], popularity:51, tags:['код']},
      {family:'Anonymous Pro', category:'monospace', weights:[400,700], popularity:52, tags:['код']},
      {family:'Roboto Slab', category:'slab', weights:[400,500,600,700], popularity:53, tags:['редакция','headline']},
      {family:'Arvo', category:'slab', weights:[400,700], popularity:54, tags:['headline','антиква']},
      {family:'Marmelad', category:'sans-serif', weights:[400], popularity:55, tags:['headline','ru']},
      {family:'Poiret One', category:'display', weights:[400], popularity:56, tags:['art deco']},
      {family:'Kelly Slab', category:'slab', weights:[400], popularity:57, tags:['display']},
      {family:'Press Start 2P', category:'display', weights:[400], popularity:58, tags:['ретро','pixel']},
      {family:'Bad Script', category:'handwriting', weights:[400], popularity:59, tags:['подпись']},
      {family:'Cousine', category:'monospace', weights:[400,700], popularity:60, tags:['код']}
    ];

    const POPULAR_PAIRINGS = [
      {id:'manrope-inter', name:'Чёткий интерфейс', description:'Manrope для заголовков, Inter для текста и UI.', heading:'manrope', text:'inter', ui:'inter'},
      {id:'montserrat-open-sans', name:'Контраст и читабельность', description:'Montserrat сочетается с Open Sans для текста и интерфейса.', heading:'montserrat', text:'open-sans', ui:'open-sans'},
      {id:'playfair-inter', name:'Редакционный акцент', description:'Playfair Display в заголовках и Inter в тексте.', heading:'playfair-display', text:'inter', ui:'manrope'},
      {id:'raleway-lora', name:'Лёгкая классика', description:'Raleway для акцентов, Lora для текста.', heading:'raleway', text:'lora', ui:'raleway'},
      {id:'pt-standard', name:'Национальный стандарт', description:'PT Sans и PT Serif знакомы российским пользователям.', heading:'pt-sans', text:'pt-serif', ui:'pt-sans'},
      {id:'rubik-manrope', name:'Современный продукт', description:'Rubik для UI, Manrope для заголовков.', heading:'rubik', text:'manrope', ui:'rubik'},
      {id:'noto-global', name:'Глобальная система', description:'Гарнитуры семейства Noto для многоязычных проектов.', heading:'noto-sans', text:'noto-serif', ui:'noto-sans'},
      {id:'ubuntu-merriweather', name:'Тёплая редакция', description:'Ubuntu дополняет глубокий Merriweather в тексте.', heading:'ubuntu', text:'merriweather', ui:'ubuntu'},
      {id:'golos-corporate', name:'Корпоративная команда', description:'Golos Text и Golos UI для интерфейсов и документов.', heading:'golos-text', text:'golos-text', ui:'golos-ui'},
      {id:'ibm-plex', name:'Технологичный стиль', description:'IBM Plex Serif для статей и Plex Sans для интерфейса.', heading:'ibm-plex-serif', text:'ibm-plex-sans', ui:'ibm-plex-sans'},
      {id:'mulish-source', name:'SaaS-платформа', description:'Mulish + Source Serif 4 + Source Sans 3.', heading:'mulish', text:'source-serif-4', ui:'source-sans-3'},
      {id:'oswald-inter', name:'Маркетинговый контраст', description:'Узкие заголовки Oswald и лаконичный Inter.', heading:'oswald', text:'inter', ui:'inter'},
      {id:'comfortaa-nunito', name:'Дружелюбная платформа', description:'Комбинация Comfortaa и Nunito/Sans.', heading:'comfortaa', text:'nunito', ui:'nunito-sans'},
      {id:'cormorant-manrope', name:'Премиальный сервис', description:'Cormorant Garamond с Lora и Manrope.', heading:'cormorant-garamond', text:'lora', ui:'manrope'},
      {id:'roboto-slab-set', name:'Редакция и блог', description:'Roboto Slab плюс классический Roboto.', heading:'roboto-slab', text:'roboto', ui:'roboto'}
    ];

    const CATEGORY_LABELS = {
      'sans-serif':'Гротеск',
      'serif':'Антиква',
      'slab':'Слаб-сериф',
      'display':'Дисплейный',
      'handwriting':'Рукописный',
      'monospace':'Моно'
    };

    const ROLE_LABELS = {
      heading:'Заголовки',
      text:'Основной текст',
      ui:'UI элементы'
    };

    const FONT_REGISTRY = {};
    RAW_FONTS.forEach(registerFont);

    const DEFAULT_FONTS = {heading:'manrope', text:'inter', ui:'manrope'};

    const headingSelect = document.getElementById('headingSelect');
    const bodySelect = document.getElementById('bodySelect');
    const uiSelect = document.getElementById('uiSelect');
    const headingMeta = document.getElementById('headingMeta');
    const bodyMeta = document.getElementById('bodyMeta');
    const uiMeta = document.getElementById('uiMeta');
    const statusMessage = document.getElementById('statusMessage');
    const notice = document.getElementById('notice');
    const resetFonts = document.getElementById('resetFonts');
    const openCatalog = document.getElementById('openCatalog');
    const scrollPairings = document.getElementById('scrollPairings');
    const randomPairing = document.getElementById('randomPairing');
    const pairingsSection = document.getElementById('pairingsSection');
    const pairingList = document.getElementById('pairingList');
    const catalogModal = document.getElementById('catalogModal');
    const catalogList = document.getElementById('catalogList');
    const catalogSearch = document.getElementById('catalogSearch');
    const catalogCategory = document.getElementById('catalogCategory');
    const catalogClose = document.getElementById('catalogClose');

    const state = loadState();
    const activeProfile = state.profiles.find(p=>p.id===state.activeId) || state.profiles[0];
    applyPalette(activeProfile);

    let fonts = loadFonts();
    applyFonts(fonts);

    populateSelects();
    updateMeta();
    renderPairings();
    renderCatalog();
    saveFonts();

    headingSelect.addEventListener('change', ()=>updateFont('heading', headingSelect.value));
    bodySelect.addEventListener('change', ()=>updateFont('text', bodySelect.value));
    uiSelect.addEventListener('change', ()=>updateFont('ui', uiSelect.value));

    resetFonts.addEventListener('click', ()=>{
      fonts = {...DEFAULT_FONTS};
      saveFonts();
      applyFonts(fonts);
      populateSelects();
      updateMeta();
      showStatus('Возвращено к стандартным шрифтам');
      showNotice('Настройки восстановлены');
    });

    openCatalog.addEventListener('click', ()=>{
      catalogModal.setAttribute('aria-hidden','false');
      catalogSearch.focus();
      renderCatalog();
    });

    catalogClose.addEventListener('click', closeCatalog);
    catalogModal.addEventListener('click', evt=>{
      if(evt.target===catalogModal) closeCatalog();
    });
    document.addEventListener('keydown', evt=>{
      if(evt.key==='Escape' && catalogModal.getAttribute('aria-hidden')==='false') closeCatalog();
    });
    catalogSearch.addEventListener('input', renderCatalog);
    catalogCategory.addEventListener('change', renderCatalog);

    scrollPairings.addEventListener('click', ()=>{
      pairingsSection.scrollIntoView({behavior:'smooth'});
    });

    randomPairing.addEventListener('click', ()=>{
      const pair = POPULAR_PAIRINGS[Math.floor(Math.random()*POPULAR_PAIRINGS.length)];
      applyPairing(pair);
    });

    function closeCatalog(){
      catalogModal.setAttribute('aria-hidden','true');
    }

    function populateSelects(){
      const fontsOrdered = getOrderedFonts();
      [headingSelect, bodySelect, uiSelect].forEach(select=>{
        const current = select.value;
        select.innerHTML='';
        fontsOrdered.forEach(font=>{
          const option = document.createElement('option');
          option.value = font.id;
          option.textContent = font.family;
          select.appendChild(option);
        });
        if(current && FONT_REGISTRY[current]){
          select.value = current;
        }
      });
      headingSelect.value = fonts.heading;
      bodySelect.value = fonts.text;
      uiSelect.value = fonts.ui;
    }

    function updateFont(role, value, {silent=false}={}){
      if(!FONT_REGISTRY[value]){
        showStatus('Выбранный шрифт недоступен');
        return;
      }
      fonts[role] = value;
      saveFonts();
      applyFonts(fonts);
      populateSelects();
      updateMeta();
      if(!silent){
        showStatus('Шрифт обновлён');
        showNotice('Шрифты сохранены');
      }
    }

    function applyPairing(pair){
      if(!pair) return;
      fonts = {heading:pair.heading, text:pair.text, ui:pair.ui};
      saveFonts();
      applyFonts(fonts);
      populateSelects();
      updateMeta();
      showStatus(`Применено сочетание «${pair.name}»`);
      showNotice('Гарнитуры обновлены');
    }

    function renderPairings(){
      pairingList.innerHTML='';
      POPULAR_PAIRINGS.forEach(pair=>{
        const card = document.createElement('div');
        card.className = 'pairing-card';
        const title = document.createElement('h3');
        title.textContent = pair.name;
        const desc = document.createElement('p');
        desc.textContent = pair.description;
        const roles = document.createElement('div');
        roles.className = 'pairing-roles';
        ['heading','text','ui'].forEach(role=>{
          const row = document.createElement('span');
          row.className = 'pairing-role';
          const font = FONT_REGISTRY[pair[role]];
          const label = document.createElement('strong');
          label.textContent = ROLE_LABELS[role];
          const value = document.createElement('span');
          value.textContent = font?.family || pair[role];
          row.append(label, value);
          roles.appendChild(row);
        });
        const button = document.createElement('button');
        button.className = 'btn';
        button.type = 'button';
        button.textContent = 'Применить';
        button.addEventListener('click', ()=>applyPairing(pair));
        card.append(title, desc, roles, button);
        pairingList.appendChild(card);
      });
    }

    function renderCatalog(){
      const query = catalogSearch.value.trim().toLowerCase();
      const category = catalogCategory.value;
      const fontsOrdered = getOrderedFonts().filter(font=>{
        const matchQuery = !query || font.family.toLowerCase().includes(query) || font.tags.some(tag=>tag.toLowerCase().includes(query));
        const matchCategory = category==='all' || font.category===category;
        return matchQuery && matchCategory;
      });
      catalogList.innerHTML='';
      if(!fontsOrdered.length){
        const empty = document.createElement('div');
        empty.className = 'catalog-empty';
        empty.textContent = 'Не найдено шрифтов по заданным параметрам.';
        catalogList.appendChild(empty);
        return;
      }
      fontsOrdered.forEach(font=>{
        const item = document.createElement('div');
        item.className = 'catalog-item';
        const title = document.createElement('h3');
        title.textContent = font.family;
        const categoryLabel = document.createElement('div');
        categoryLabel.className = 'category';
        categoryLabel.textContent = CATEGORY_LABELS[font.category] || font.category;
        const preview = document.createElement('div');
        preview.className = 'catalog-preview';
        preview.style.fontFamily = font.stack;
        preview.textContent = 'Съешь же ещё этих мягких французских булок';
        const tags = document.createElement('div');
        tags.className = 'catalog-tags';
        font.tags.forEach(tag=>{
          const badge = document.createElement('span');
          badge.textContent = tag;
          tags.appendChild(badge);
        });
        const actions = document.createElement('div');
        actions.className = 'catalog-actions';
        Object.entries(ROLE_LABELS).forEach(([role,label])=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn';
          btn.textContent = label;
          btn.addEventListener('click', ()=>{
            updateFont(role, font.id, {silent:true});
            showStatus(`${label}: ${font.family}`);
            showNotice('Шрифт применён');
          });
          actions.appendChild(btn);
        });
        item.append(title, categoryLabel, preview, tags, actions);
        catalogList.appendChild(item);
      });
    }

    function updateMeta(){
      headingMeta.textContent = describeFont(fonts.heading);
      bodyMeta.textContent = describeFont(fonts.text);
      uiMeta.textContent = describeFont(fonts.ui);
    }

    function describeFont(id){
      const font = FONT_REGISTRY[id];
      if(!font) return id;
      const label = CATEGORY_LABELS[font.category] || font.category;
      return `${font.family} • ${label}`;
    }

    function showStatus(text){
      statusMessage.textContent = text;
    }

    function showNotice(text){
      notice.textContent = text;
      notice.classList.add('show');
      clearTimeout(showNotice.timer);
      showNotice.timer = setTimeout(()=>notice.classList.remove('show'),1400);
    }

    function saveFonts(){
      const payload = {
        heading:serializeFont(fonts.heading),
        text:serializeFont(fonts.text),
        ui:serializeFont(fonts.ui)
      };
      localStorage.setItem(FONT_KEY, JSON.stringify(payload));
    }

    function loadFonts(){
      try{
        const raw = localStorage.getItem(FONT_KEY);
        if(!raw) return {...DEFAULT_FONTS};
        const parsed = JSON.parse(raw);
        if(typeof parsed === 'object' && parsed !== null && typeof parsed.heading !== 'string'){
          return {
            heading: normalizeStoredFont(parsed.heading, DEFAULT_FONTS.heading),
            text: normalizeStoredFont(parsed.text, DEFAULT_FONTS.text),
            ui: normalizeStoredFont(parsed.ui, DEFAULT_FONTS.ui)
          };
        }
        return {
          heading: FONT_REGISTRY[parsed.heading]?parsed.heading:DEFAULT_FONTS.heading,
          text: FONT_REGISTRY[parsed.text]?parsed.text:DEFAULT_FONTS.text,
          ui: FONT_REGISTRY[parsed.ui]?parsed.ui:DEFAULT_FONTS.ui
        };
      }catch(e){
        return {...DEFAULT_FONTS};
      }
    }

    function applyFonts(fonts){
      const root = document.documentElement;
      ['heading','text','ui'].forEach(key=>{
        const id = fonts[key];
        const fallbackId = DEFAULT_FONTS[key] || DEFAULT_FONTS.heading;
        const font = FONT_REGISTRY[id] || FONT_REGISTRY[fallbackId];
        if(font){
          ensureFontLoaded(font);
          root.style.setProperty(key==='heading'?'--font-heading':key==='text'?'--font-body':'--font-ui', font.stack);
        }
      });
    }

    function getOrderedFonts(){
      return Object.values(FONT_REGISTRY).sort((a,b)=>{
        if(a.popularity!==b.popularity) return a.popularity-b.popularity;
        return a.family.localeCompare(b.family);
      });
    }

    function ensureFontLoaded(font){
      const id = 'font-'+font.id;
      if(document.getElementById(id)) return;
      const link = document.createElement('link');
      link.id = id;
      link.rel = 'stylesheet';
      link.href = font.css;
      document.head.appendChild(link);
    }

    function registerFont(def){
      if(!def?.family) return null;
      const id = slugify(def.family);
      if(FONT_REGISTRY[id]) return FONT_REGISTRY[id];
      const category = def.category || 'sans-serif';
      const weights = Array.isArray(def.weights) && def.weights.length ? def.weights : [400];
      const entry = {
        id,
        family: def.family,
        category,
        popularity: Number.isFinite(def.popularity) ? def.popularity : 999,
        tags: Array.isArray(def.tags) ? def.tags : [],
        weights,
        stack: `'${def.family}', ${fallbackCategory(category)}`,
        css: buildCssUrl(def.family, weights)
      };
      FONT_REGISTRY[id] = entry;
      return entry;
    }

    function slugify(value){
      return String(value).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }

    function fallbackCategory(category){
      switch(category){
        case 'serif':
          return 'serif';
        case 'slab':
          return 'serif';
        case 'monospace':
          return 'monospace';
        case 'handwriting':
          return 'cursive';
        default:
          return 'sans-serif';
      }
    }

    function buildCssUrl(family, weights){
      const normalized = Array.from(new Set((weights||[400]).map(w=>parseInt(w,10)||400))).sort((a,b)=>a-b);
      const axis = normalized.length ? `:wght@${normalized.join(';')}` : '';
      const familyParam = family.trim().replace(/\s+/g,'+');
      return `https://fonts.googleapis.com/css2?family=${familyParam}${axis}&display=swap&subset=cyrillic`;
    }

    function serializeFont(id){
      const font = FONT_REGISTRY[id];
      if(font){
        return {id:font.id, family:font.family, stack:font.stack, css:font.css, category:font.category, weights:font.weights, tags:font.tags};
      }
      return {id, family:id, stack:"'Inter', sans-serif", css:'', category:'sans-serif', weights:[400], tags:[]};
    }

    function normalizeStoredFont(entry, fallbackId){
      if(entry && typeof entry === 'object'){
        if(entry.id && !FONT_REGISTRY[entry.id] && entry.stack){
          FONT_REGISTRY[entry.id] = {
            id: entry.id,
            family: entry.family || entry.id,
            category: entry.category || 'sans-serif',
            popularity: 999,
            tags: Array.isArray(entry.tags) ? entry.tags : [],
            weights: [],
            stack: entry.stack,
            css: entry.css || buildCssUrl(entry.family || entry.id, entry.weights || [400])
          };
        }
        if(entry.id && FONT_REGISTRY[entry.id]) return entry.id;
        if(entry.family){
          const slug = slugify(entry.family);
          if(FONT_REGISTRY[slug]) return slug;
        }
      }
      return fallbackId;
    }

    function loadState(){
      const fallback = structuredClone(DEFAULT_STATE);
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return hydrateState(fallback);
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.profiles)) return hydrateState(fallback);
        const hydrated = hydrateState(parsed);
        if(!hydrated.profiles.find(p=>p.id===hydrated.activeId)) hydrated.activeId = hydrated.profiles[0]?.id || fallback.activeId;
        return hydrated;
      }catch(e){
        return hydrateState(fallback);
      }
    }

    function hydrateState(state){
      return {
        activeId: state.activeId || state.profiles[0]?.id || 'soft-light',
        profiles: (state.profiles || []).map(normalizeProfile)
      };
    }

    function normalizeProfile(profile){
      const base = {};
      BASE_TOKENS.forEach(token=>{
        const value = profile.base?.[token.variable] || token.default;
        base[token.variable] = normalizeHex(value) || token.default;
      });
      const aliases = {};
      ALIAS_DEFS.forEach(def=>{
        const stored = profile.aliases?.[def.variable];
        let config = stored && stored.mode ? {...stored} : def.defaultConfig();
        if(config.mode==='base' && !BASE_TOKENS.find(t=>t.variable===config.ref)){
          config = def.defaultConfig();
        }
        if(config.mode==='custom'){
          config.value = normalizeHex(config.value || '');
          if(!config.value) config = def.defaultConfig();
        }
        aliases[def.variable] = config;
      });
      return {id: profile.id || randomId(), name: profile.name || 'Безымянный профиль', base, aliases};
    }

    function applyPalette(profile){
      const root = document.documentElement;
      Object.entries(profile.base).forEach(([key,value])=>root.style.setProperty(key,value));
      const aliases = resolveAliases(profile);
      Object.entries(aliases).forEach(([key,value])=>root.style.setProperty(key,value));
    }

    function resolveAliases(profile){
      const aliasColors = {};
      ALIAS_DEFS.forEach(def=>{
        const config = profile.aliases?.[def.variable] || def.defaultConfig();
        let color;
        if(config.mode==='base'){
          color = profile.base[config.ref];
        }else if(config.mode==='custom'){
          color = config.value;
        }else if(config.mode==='auto' && typeof def.auto==='function'){
          color = def.auto(profile.base, aliasColors, config);
        }
        if(!color){
          const fallbackRef = def.defaultConfig().ref;
          color = fallbackRef ? profile.base[fallbackRef] : '#000000';
        }
        aliasColors[def.variable] = color;
      });
      return aliasColors;
    }

    function mixColors(hexA, hexB, weightB){
      const a = parseHex(hexA || '#000000');
      const b = parseHex(hexB || '#000000');
      const wb = Number.isFinite(weightB) ? weightB : 0.5;
      const wa = 1 - wb;
      const mix = {
        r:Math.round(a.r*wa + b.r*wb),
        g:Math.round(a.g*wa + b.g*wb),
        b:Math.round(a.b*wa + b.b*wb)
      };
      return rgbToHex(mix);
    }

    function parseHex(hex){
      const normalized = normalizeHex(hex) || '#000000';
      return {
        r:parseInt(normalized.slice(1,3),16),
        g:parseInt(normalized.slice(3,5),16),
        b:parseInt(normalized.slice(5,7),16)
      };
    }

    function rgbToHex({r,g,b}){
      return '#'+[r,g,b].map(v=>{
        const h=v.toString(16).toUpperCase();
        return h.length===1?'0'+h:h;
      }).join('');
    }

    function normalizeHex(value){
      if(!value) return '';
      let hex = String(value).trim();
      if(hex.startsWith('#')) hex = hex.slice(1);
      if(hex.length===3){
        hex = hex.split('').map(ch=>ch+ch).join('');
      }
      if(!/^[0-9a-fA-F]{6}$/.test(hex)) return '';
      return '#'+hex.toUpperCase();
    }

    function randomId(){
      return 'id-'+Math.random().toString(36).slice(2,8);
    }

    function structuredClone(obj){
      return JSON.parse(JSON.stringify(obj));
    }
  </script>
</body>
</html>
